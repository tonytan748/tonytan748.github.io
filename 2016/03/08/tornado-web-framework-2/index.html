<!doctype html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/theme.css">
    <link rel="shortcut icon" href="/favicon.png">
    
    <title>Tornado Web Framework 2 - Tony Tan</title>
    
</head>
<body>
    <div class="header-title">
        <span class="header-light"></span>
        <span class="header-light"></span>
        <span class="header-light"></span>
        <span>Tony Tan tonytan748.github.io<span>
    </span></span></div>
    <div class="container">
        <ul class="nav">
        
            <li><a href="/">首页</a></li>
        
            <li><a href="/categories">分类</a></li>
        
            <li><a href="/about">关于</a></li>
        
        </ul>
        <div class="content">
            <div class="post-container">
    <div class="post-header">
        <span class="ui-tips">标题：</span>
        <h1 class="ui-keyword post-title">Tornado Web Framework 2</h1>
        <span class="post-date">2016-03-08</span>
    </div>
    
    <div class="post-header">
        <span class="ui-tips">分类：</span>
        
        <a href="/categories/python/">python</a>
        
    </div>
    
    
    
    <div class="post-content"><p><em>Tornado Web Framework 2 Form and Module</em></p>
<p><em>文章转自<a href="http://demo.pythoner.com/itt2zh/ch2.html" target="_blank" rel="noopener">这里</a></em></p>
<p>在第一章中，我们学习了使用Tornado创建一个Web应用的基础知识。包括处理函数、HTTP方法以及Tornado框架的总体结构。在这章中，我们将学习一些你在创建Web应用时经常会用到的更强大的功能。</p>
<p>和大多数Web框架一样，Tornado的一个重要目标就是帮助你更快地编写程序，尽可能整洁地复用更多的代码。尽管Tornado足够灵活，可以使用几乎所有Python支持的模板语言，Tornado自身也提供了一个轻量级、快速并且灵活的模板语言在tornado.template模块中。</p>
<h2 id="2-1-简单示例：Poem-Maker-Pro"><a href="#2-1-简单示例：Poem-Maker-Pro" class="headerlink" title="2.1 简单示例：Poem Maker Pro"></a>2.1 简单示例：Poem Maker Pro</h2><p>让我们以一个叫作Poem Maker Pro的简单例子开始。Poem Maker Pro这个Web应用有一个让用户填写的HTML表单，然后处理表单的结果。代码清单2-1是它的Python代码。</p>
<p><em>代码清单2-1 简单表单和模板：poemmaker.py</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import os.path</span><br><span class="line">import tornado.httpserver</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.options</span><br><span class="line">import tornado.web</span><br><span class="line"></span><br><span class="line">from tornado.options import define, options</span><br><span class="line">define(&quot;port&quot;, default=8000, help=&quot;run on the given port&quot;, type=int)</span><br><span class="line"></span><br><span class="line">class IndexHandler(tornado.web.RequestHandler):</span><br><span class="line">	def get(self):</span><br><span class="line">		self.render(&quot;index.html&quot;)</span><br><span class="line"></span><br><span class="line">class PoemPageHandler(tornado.web.RequestHandler):</span><br><span class="line">	def post(self):</span><br><span class="line">		noun1 = self.get_argument(&apos;noun1&apos;)</span><br><span class="line">		noun2 = self.get_argument(&apos;noun2&apos;)</span><br><span class="line">		verb = self.get_argument(&apos;verb&apos;)</span><br><span class="line">		noun3 = self.get_argument(&apos;noun3&apos;)</span><br><span class="line">		self.render(&apos;poem.html&apos;, roads=noun1, wood=noun2, made=verb, difference=noun3)</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">	tornado.options.parse_command_line()</span><br><span class="line">	app = tornado.web.Application(</span><br><span class="line">		handler=[(r&apos;/&apos;, IndexHandler),(r&apos;/poem&apos;, PoemPageHandler)],</span><br><span class="line">		template_path = os.path.join(os.path.dirname(__file__), &apos;templates&apos;)</span><br><span class="line">	)</span><br><span class="line">		http_server = tornado.httpserver.HTTPServer(app)</span><br><span class="line">		http_server.listen(options.port)</span><br><span class="line">		tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>
<p>除了poemmaker.py，你还需要将代码清单2-2和代码清单2-3中的两个文件加入到templates子文件夹中。</p>
<p><em>代码清单2-2 Poem Maker表单：index.html</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;&lt;title&gt;Poem Marker Pro&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;h1&gt;Enter terms below.&lt;/h1&gt;</span><br><span class="line">		&lt;form method=&quot;post&quot; action=&quot;/poem&quot;&gt;</span><br><span class="line">			&lt;p&gt;Plural noun&lt;br&gt;</span><br><span class="line">			&lt;input type=&quot;text&quot; name=&quot;noun1&quot;&gt;&lt;/p&gt;</span><br><span class="line">			&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;noun2&quot;&gt;&lt;/p&gt;</span><br><span class="line">			&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;verb&quot;&gt;&lt;/p&gt;</span><br><span class="line">			&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;noun3&quot;&gt;&lt;/p&gt;</span><br><span class="line">			&lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">		&lt;/form&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><em>代码清单2-3 Poem Maker模板：poem.html</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Your poem&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;Two &#123;&#123;roads&#125;&#125; diverged in a &#123;&#123;wood&#125;&#125;, and I—&lt;br&gt;</span><br><span class="line">I took the one less travelled by,&lt;br&gt;</span><br><span class="line">And that has &#123;&#123;made&#125;&#125; all the &#123;&#123;difference&#125;&#125;.&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>在命令行执行下述命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python poemmaker.py --port=8000</span><br></pre></td></tr></table></figure>
<p>现在，在浏览器中打开<a href="http://localhost:8000。当浏览器请求根目录（/）时，Tornado程序将渲染index.html，展示如图2-1所示的简单HTML表单。" target="_blank" rel="noopener">http://localhost:8000。当浏览器请求根目录（/）时，Tornado程序将渲染index.html，展示如图2-1所示的简单HTML表单。</a></p>
<p>这个表单包括多个文本域（命名为noun1、noun2等），其中的内容将在用户点击”Submit”按钮时以POST请求的方式送到/poem。现在往里面填写东西然后点击提交吧。</p>
<p>为了响应这个POST请求，Tornado应用跳转到poem.html，插入你在表单中填写的值。结果是Robert Frost的诗《The Road Not Taken》的轻微修改版本。图2-2展示了这个结果。</p>
<h4 id="2-1-1-渲染模板"><a href="#2-1-1-渲染模板" class="headerlink" title="2.1.1 渲染模板"></a>2.1.1 渲染模板</h4><p>从结构上讲，poemmaker.py和第一章中的例子很相似。我们定义了几个RequestHandler子类并把它们传给tornado.web.Application对象。那么有什么不一样的地方呢？首先，我们向Application对象的<strong>init</strong>方法传递了一个template_path参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">template_path=os.path.join(os.path.dirname(__file__), &quot;templates&quot;)</span><br></pre></td></tr></table></figure>
<p>template_path参数告诉Tornado在哪里寻找模板文件。我们将在本章和第三章中讲解其确切性质和语法，而它的基本要点是：模板是一个允许你嵌入Python代码片段的HTML文件。上面的代码告诉Python在你Tornado应用文件同目录下的templates文件夹中寻找模板文件</p>
<p>一旦我们告诉Tornado在哪里找到模板，我们可以使用RequestHandler类的render方法来告诉Tornado读入模板文件，插入其中的模版代码，并返回结果给浏览器。比如，在IndexHandler中，我们发现了下面的语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.render(&apos;index.html&apos;)</span><br></pre></td></tr></table></figure>
<p>这段代码告诉Tornado在templates文件夹下找到一个名为index.html的文件，读取其中的内容，并且发送给浏览器。</p>
<h4 id="2-1-2-填充"><a href="#2-1-2-填充" class="headerlink" title="2.1.2 填充"></a>2.1.2 填充</h4><p>实际上index.html完全不能称之为”模板”，它所包含的完全是已编写好的HTML标记。这可以是模板的一个不错的使用方式，但在更通常的情况下我们希望HTML输出可以结合我们的程序传入给模板的值。模板poem.html使用PoemPageHandler渲染，是这种方式的一个很好的例子。让我们看看它是如何工作的吧。</p>
<p>在poem.html中，你可以看到模板中有一些被双大括号（）括起来的字符串，就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Two &#123;&#123;roads&#125;&#125; diverged in a &#123;&#123;wood&#125;&#125;, and I—&lt;br/&gt;</span><br><span class="line">I took the one less travelled by,&lt;br&gt;</span><br><span class="line">And that has &#123;&#123;made&#125;&#125; all the &#123;&#123;difference&#125;&#125;.&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<p>在双大括号中的单词是占位符，当我们渲染模板时希望以实际值代替。我们可以使用向render函数中传递关键字参数的方法指定什么值将被填充到HTML文件中的对应位置，其中关键字对应模板文件中占位符的名字。下面是在PoemPageHandler中相应的代码部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">noun1 = self.get_argument(&apos;noun1&apos;)</span><br><span class="line">noun2 = self.get_argument(&apos;noun2&apos;)</span><br><span class="line">verb = self.get_argument(&apos;verb&apos;)</span><br><span class="line">noun3 = self.get_argument(&apos;noun3&apos;)</span><br><span class="line">self.render(&apos;poem.html&apos;, roads=noun1, wood=noun2, made=verb, difference=noun3)</span><br></pre></td></tr></table></figure>
<p>在这里，我们告诉模板使用变量noun1（该变量是从get_argument方法取得的）作为模板中roads的值，noun2作为模板中wood的值，依此类推。假设用户在表单中按顺序键入了pineapples、grandfather clock、irradiated和supernovae，那么结果HTML将会如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Two pineapples diverged in a grandfather clock, and I—&lt;br&gt;</span><br><span class="line">I took the one less travelled by,&lt;br&gt;</span><br><span class="line">And that has irradiated all the supernovae.&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-模板语法"><a href="#2-2-模板语法" class="headerlink" title="2.2 模板语法"></a>2.2 模板语法</h2><p>既然我们已经看到了一个模板在实际应用中的简单例子，那么让我们深入地了解它们是如何工作的吧。Tornado模板是被Python表达式和控制语句标记的简单文本文件。Tornado的语法非常简单直接。熟悉Django、Liquid或其他相似框架的用户会发现它们非常相似，很容易学会。</p>
<p>在2.1节中，我们展示了如何在一个Web应用中使用render方法传送HTML给浏览器。你可以在Tornado应用之外使用Python解释器导入模板模块尝试模板系统，此时结果会被直接输出出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from tornado.template import Template</span><br><span class="line">&gt;&gt;&gt; content = Template(&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;&#123;&#123; header &#125;&#125;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;)</span><br><span class="line">&gt;&gt;&gt; print content.generate(header=&quot;Welcome!&quot;)</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;Welcome!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-1-填充表达式"><a href="#2-2-1-填充表达式" class="headerlink" title="2.2.1 填充表达式"></a>2.2.1 填充表达式</h4><p>在代码清单2-1中，我们演示了填充Python变量的值到模板的双大括号中的使用。实际上，你可以将任何Python表达式放在双大括号中。Tornado将插入一个包含任何表达式计算结果值的字符串到输出中。下面是几个可能的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from tornado.template import Template</span><br><span class="line">&gt;&gt;&gt; print Template(&quot;&#123;&#123; 1+1 &#125;&#125;&quot;).generate()</span><br><span class="line">2</span><br><span class="line">&gt;&gt;&gt; print Template(&quot;&#123;&#123; &apos;scrambled eggs&apos;[-4:] &#125;&#125;&quot;).generate()</span><br><span class="line">eggs</span><br><span class="line">&gt;&gt;&gt; print Template(&quot;&#123;&#123; &apos;, &apos;.join([str(x*x) for x in range(10)]) &#125;&#125;&quot;).generate()</span><br><span class="line">0, 1, 4, 9, 16, 25, 36, 49, 64, 81</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-控制流语句"><a href="#2-2-2-控制流语句" class="headerlink" title="2.2.2 控制流语句"></a>2.2.2 控制流语句</h4><p>你同样可以在Tornado模板中使用Python条件和循环语句。控制语句以{\%和\%}包围，并以类似下面的形式被使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if len(entries) == 3 %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>控制语句的大部分就像对应的Python语句一样工作，支持if、for、while和try。在这些情况下，语句块以{\%开始，并以\%}结束。</p>
<p>所以这个模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;&#123;&#123; title &#125;&#125;&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&#123;&#123; header &#125;&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &#123;% for book in books %&#125;</span><br><span class="line">                &lt;li&gt;&#123;&#123; book &#125;&#125;&lt;/li&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>当被下面这个处理函数调用时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class BookHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.render(</span><br><span class="line">            &quot;book.html&quot;,</span><br><span class="line">            title=&quot;Home Page&quot;,</span><br><span class="line">            header=&quot;Books that are great&quot;,</span><br><span class="line">            books=[</span><br><span class="line">                &quot;Learning Python&quot;,</span><br><span class="line">                &quot;Programming Collective Intelligence&quot;,</span><br><span class="line">                &quot;Restful Web Services&quot;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>将会渲染得到下面的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Home Page&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;Books that are great&lt;/h1&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li&gt;Learning Python&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;Programming Collective Intelligence&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;Restful Web Services&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>不像许多其他的Python模板系统，Tornado模板语言的一个最好的东西是在if和for语句块中可以使用的表达式没有限制。因此，你可以在你的模板中执行所有的Python代码。</p>
<p>同样，你也可以在你的控制语句块中间使用{\% set foo = ‘bar’ \%}来设置变量。你还有很多可以在控制语句块中做的事情，但是在大多数情况下，你最好使用UI模块来做更复杂的划分。我们稍后会更详细的看到这一点。</p>
<h4 id="2-2-3-在模板中使用函数"><a href="#2-2-3-在模板中使用函数" class="headerlink" title="2.2.3 在模板中使用函数"></a>2.2.3 在模板中使用函数</h4><p>Tornado在所有模板中默认提供了一些便利的函数。它们包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escape(s)</span><br></pre></td></tr></table></figure>
<p>替换字符串s中的&amp;、&lt;、&gt;为他们对应的HTML字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_escape(s)</span><br></pre></td></tr></table></figure>
<p>使用urllib.quote_plus替换字符串s中的字符为URL编码形式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json_encode(val)</span><br></pre></td></tr></table></figure>
<p>将val编码成JSON格式。（在系统底层，这是一个对json库的dumps函数的调用。查阅相关的文档以获得更多关于该函数接收和返回参数的信息。）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">squeeze(s)</span><br></pre></td></tr></table></figure>
<p>过滤字符串s，把连续的多个空白字符替换成一个空格。</p>
<p>在Tornado 1.x中，模版不是被自动转义的。在Tornado 2.0中，模板被默认为自动转义（并且可以在Application构造函数中使用autoscaping=None关闭）。在不同版本的迁移时要注意向后兼容。</p>
<p>在模板中使用一个你自己编写的函数也是很简单的：只需要将函数名作为模板的参数传递即可，就像其他变量一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from tornado.template import Template</span><br><span class="line">&gt;&gt;&gt; def disemvowel(s):</span><br><span class="line">...     return &apos;&apos;.join([x for x in s if x not in &apos;aeiou&apos;])</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; disemvowel(&quot;george&quot;)</span><br><span class="line">&apos;grg&apos;</span><br><span class="line">&gt;&gt;&gt; print Template(&quot;my name is &#123;&#123;d(&apos;mortimer&apos;)&#125;&#125;&quot;).generate(d=disemvowel)</span><br><span class="line">my name is mrtmr</span><br></pre></td></tr></table></figure>
<h2 id="2-3-复杂示例：The-Alpha-Munger"><a href="#2-3-复杂示例：The-Alpha-Munger" class="headerlink" title="2.3 复杂示例：The Alpha Munger"></a>2.3 复杂示例：The Alpha Munger</h2><p>在代码清单2-4中，我们把在这一章中谈论过的所有东西都放了进来。这个应用被称为The Alpha Munger。用户输入两个文本：一个”源”文本和一个”替代”文本。应用会返回替代文本的一个副本，并将其中每个单词替换成源文本中首字母相同的某个单词。图2-3展示了要填的表单，图2-4展示了结果文本。</p>
<p>这个应用包括四个文件：main.py（Tornado程序）、style.css（CSS样式表文件）、index.html和munged.html（Tornado模板）。让我们看看代码吧：</p>
<p><em>代码清单2-4 复杂表单和模板：main.py</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import os.path</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">import tornado.httpserver</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.options</span><br><span class="line">import tornado.web</span><br><span class="line"></span><br><span class="line">from tornado.options import define, options</span><br><span class="line">define(&quot;port&quot;, default=8000, help=&quot;run on the given port&quot;, type=int)</span><br><span class="line"></span><br><span class="line">class IndexHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.render(&apos;index.html&apos;)</span><br><span class="line"></span><br><span class="line">class MungedPageHandler(tornado.web.RequestHandler):</span><br><span class="line">    def map_by_first_letter(self, text):</span><br><span class="line">        mapped = dict()</span><br><span class="line">        for line in text.split(&apos;\r\n&apos;):</span><br><span class="line">            for word in [x for x in line.split(&apos; &apos;) if len(x) &gt; 0]:</span><br><span class="line">                if word[0] not in mapped: mapped[word[0]] = []</span><br><span class="line">                mapped[word[0]].append(word)</span><br><span class="line">        return mapped</span><br><span class="line"></span><br><span class="line">    def post(self):</span><br><span class="line">        source_text = self.get_argument(&apos;source&apos;)</span><br><span class="line">        text_to_change = self.get_argument(&apos;change&apos;)</span><br><span class="line">        source_map = self.map_by_first_letter(source_text)</span><br><span class="line">        change_lines = text_to_change.split(&apos;\r\n&apos;)</span><br><span class="line">        self.render(&apos;munged.html&apos;, source_map=source_map, change_lines=change_lines,</span><br><span class="line">                choice=random.choice)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    tornado.options.parse_command_line()</span><br><span class="line">    app = tornado.web.Application(</span><br><span class="line">        handlers=[(r&apos;/&apos;, IndexHandler), (r&apos;/poem&apos;, MungedPageHandler)],</span><br><span class="line">        template_path=os.path.join(os.path.dirname(__file__), &quot;templates&quot;),</span><br><span class="line">        static_path=os.path.join(os.path.dirname(__file__), &quot;static&quot;),</span><br><span class="line">        debug=True</span><br><span class="line">    )</span><br><span class="line">    http_server = tornado.httpserver.HTTPServer(app)</span><br><span class="line">    http_server.listen(options.port)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>
<p>记住Application构造函数中的static_path参数。我们将在下面进行详细的介绍，但是现在你所需要知道的就是static_path参数指定了你应用程序放置静态资源（如图像、CSS文件、JavaScript文件等）的目录。另外，你还需要在templates文件夹下添加index.html和munged.html这两个文件。</p>
<p><em>代码清单2-5 Alpha Munger表单：index.html</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; static_url(&quot;style.css&quot;) &#125;&#125;&quot;&gt;</span><br><span class="line">        &lt;title&gt;The Alpha Munger&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;The Alpha Munger&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Enter two texts below. The replacement text will have its words</span><br><span class="line">            replaced by words beginning with the same letter in the source text.&lt;/p&gt;</span><br><span class="line">        &lt;form method=&quot;post&quot; action=&quot;/poem&quot;&gt;</span><br><span class="line">        &lt;p&gt;Source text&lt;br&gt;</span><br><span class="line">            &lt;textarea rows=4 cols=55 name=&quot;source&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;Text for replacement&lt;br&gt;</span><br><span class="line">            &lt;textarea rows=4 cols=55 name=&quot;change&quot;&gt;&lt;/textarea&gt;&lt;/p&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><em>代码清单2-6 Alpha Munger模板：munged.html</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; static_url(&quot;style.css&quot;) &#125;&#125;&quot;&gt;</span><br><span class="line">        &lt;title&gt;The Alpha Munger&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;Your text&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">&#123;% for line in change_lines %&#125;</span><br><span class="line">    &#123;% for word in line.split(&apos; &apos;) %&#125;</span><br><span class="line">        &#123;% if len(word) &gt; 0 and word[0] in source_map %&#125;</span><br><span class="line">            &lt;span class=&quot;replaced&quot;</span><br><span class="line">                    title=&quot;&#123;&#123;word&#125;&#125;&quot;&gt;&#123;&#123; choice(source_map[word[0]]) &#125;&#125;&lt;/span&gt;</span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            &lt;span class=&quot;unchanged&quot; title=&quot;unchanged&quot;&gt;&#123;&#123;word&#125;&#125;&lt;/span&gt;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">            &lt;br&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>最后，将代码清单2-7中的内容写到static子目录下的style.css文件中。</p>
<p><em>代码清单2-7 Alpha Munger样式表：style.css</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">body &#123;</span><br><span class="line">    font-family: Helvetica,Arial,sans-serif;</span><br><span class="line">    width: 600px;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">&#125;</span><br><span class="line">.replaced:hover &#123; color: #00f; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-1-它如何工作"><a href="#2-3-1-它如何工作" class="headerlink" title="2.3.1 它如何工作"></a>2.3.1 它如何工作</h4><p>这个Tornado应用定义了两个请求处理类：IndexHandler和MungedPageHandler。IndexHandler类简单地渲染了index.html中的模板，其中包括一个允许用户POST一个源文本（在source域中）和一个替换文本（在change域中）到/poem的表单。</p>
<p>MungedPageHandler类用于处理到/poem的POST请求。当一个请求到达时，它对传入的数据进行一些基本的处理，然后为浏览器渲染模板。map_by_first_letter方法将传入的文本（从source域）分割成单词，然后创建一个字典，其中每个字母表中的字母对应文本中所有以其开头的单词（我们将其放入一个叫作source_map的变量）。再把这个字典和用户在替代文本（表单的change域）中指定的内容一起传给模板文件munged.html。此外，我们还将Python标准库的random.choice函数传入模板，这个函数以一个列表作为输入，返回列表中的任一元素。</p>
<p>在munged.html中，我们迭代替代文本中的每行，再迭代每行中的每个单词。如果当前单词的第一个字母是source_map字典的一个键，我们使用random.choice函数从字典的值中随机选择一个单词并展示它。如果字典的键中没有这个字母，我们展示源文本中的原始单词。每个单词包括一个span标签，其中的class属性指定这个单词是替换后的（class=”replaced”）还是原始的（class=”unchanged”）。（我们还将原始单词放到了span标签的title属性中，以便于用户在鼠标经过单词时可以查看是什么单词被替代了。你可以在图2-5中看到这个动作。）</p>
<p>在这个例子中，你可能注意到了debug=True的使用。它调用了一个便利的测试模式：tornado.autoreload模块，此时，一旦主要的Python文件被修改，Tornado将会尝试重启服务器，并且在模板改变时会进行刷新。对于快速改变和实时更新这非常棒，但不要再生产上使用它，因为它将防止Tornado缓存模板！</p>
<h4 id="2-3-2-提供静态文件"><a href="#2-3-2-提供静态文件" class="headerlink" title="2.3.2 提供静态文件"></a>2.3.2 提供静态文件</h4><p>当编写Web应用时，你总希望提供像样式表、JavaScript文件和图像这样不需要为每个文件编写独立处理函数的”静态内容”。Tornado提供了几个有用的捷径来使其变得容易。</p>
<h5 id="2-3-2-1-设置静态路径"><a href="#2-3-2-1-设置静态路径" class="headerlink" title="2.3.2.1 设置静态路径"></a>2.3.2.1 设置静态路径</h5><p>你可以通过向Application类的构造函数传递一个名为static_path的参数来告诉Tornado从文件系统的一个特定位置提供静态文件。Alpha Munger中的相关代码片段如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app = tornado.web.Application(</span><br><span class="line">    handlers=[(r&apos;/&apos;, IndexHandler), (r&apos;/poem&apos;, MungedPageHandler)],</span><br><span class="line">    template_path=os.path.join(os.path.dirname(__file__), &quot;templates&quot;),</span><br><span class="line">    static_path=os.path.join(os.path.dirname(__file__), &quot;static&quot;),</span><br><span class="line">    debug=True</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在这里，我们设置了一个当前应用目录下名为static的子目录作为static_path的参数。现在应用将以读取static目录下的filename.ext来响应诸如/static/filename.ext的请求，并在响应的主体中返回。</p>
<h5 id="2-3-2-2-使用static-url生成静态URL"><a href="#2-3-2-2-使用static-url生成静态URL" class="headerlink" title="2.3.2.2 使用static_url生成静态URL"></a>2.3.2.2 使用static_url生成静态URL</h5><p>Tornado模板模块提供了一个叫作static_url的函数来生成static目录下文件的URL。让我们来看看在index.html中static_url的调用的示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; static_url(&quot;style.css&quot;) &#125;&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>这个对static_url的调用生成了URL的值，并渲染输出类似下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/static/style.css?v=ab12&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>那么为什么使用static_url而不是在你的模板中硬编码呢？有如下几个原因。其一，static_url函数创建了一个基于文件内容的hash值，并将其添加到URL末尾（查询字符串的参数v）。这个hash值确保浏览器总是加载一个文件的最新版而不是之前的缓存版本。无论是在你应用的开发阶段，还是在部署到生产环境使用时，都非常有用，因为你的用户不必再为了看到你的静态内容而清除浏览器缓存了。</p>
<p>另一个好处是你可以改变你应用URL的结构，而不需要改变模板中的代码。例如，你可以配置Tornado响应来自像路径/s/filename.ext的请求时提供静态内容，而不是默认的/static路径。如果你使用static_url而不是硬编码的话，你的代码不需要改变。比如说，你想把静态资源从我们刚才使用的/static目录移到新的/s目录。你可以简单地改变静态路径由static变为s，然后每个使用static_url包裹的引用都会被自动更新。如果你在每个引用静态资源的文件中硬编码静态路径部分，你将不得不手动修改每个模板。</p>
<h4 id="2-3-3-模板的下一步"><a href="#2-3-3-模板的下一步" class="headerlink" title="2.3.3 模板的下一步"></a>2.3.3 模板的下一步</h4><p>到目前为止，你已经能够处理Tornado模板系统的简单功能了。对于像Alpha Munger这样简单的Web应用而言，基础的功能对你而言足够用了。但是我们在模板部分的学习并没有结束。Tornado在块和模块的形式上仍然有一些技巧，这两个功能使得编写和维护复杂的Web应用更加简单。我们将在第三章中看到这些功能。</p>
</div>
</div>

        </div>
        <div class="footer">
            
            <p class="footer-copyright">
                <span>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></span>
                <span>Theme <a target="_blank" href="https://github.com/tinkink-co/hexo-theme-terminal">Terminal</a></span>
            </p>
        </div>
    </div>
</body>
</html>
