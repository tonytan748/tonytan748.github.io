<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Tony Tan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Tony Tan">
<meta name="keywords" content="Tony Tan">
<meta property="og:type" content="website">
<meta property="og:title" content="Tony Tan">
<meta property="og:url" content="https://tonytan748.github.io/page/7/index.html">
<meta property="og:site_name" content="Tony Tan">
<meta property="og:description" content="Tony Tan">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tony Tan">
<meta name="twitter:description" content="Tony Tan">
  
    <link rel="alternate" href="/atom.xml" title="Tony Tan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tony Tan</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">a python progrmmer</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tonytan748.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-SQLAlchemy-Example-Create-Database-CURD-Faker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/03/SQLAlchemy-Example-Create-Database-CURD-Faker/" class="article-date">
  <time datetime="2017-04-03T14:37:37.000Z" itemprop="datePublished">2017-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/sqlalchemy/">sqlalchemy</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/03/SQLAlchemy-Example-Create-Database-CURD-Faker/">SQLAlchemy Example: Create Database, CURD, Faker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install sqlalchemy</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install faker</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"># coding: utf-8</span><br><span class="line">import random</span><br><span class="line">from faker import Factory</span><br><span class="line"></span><br><span class="line">from sqlalchemy import create_engine, Table</span><br><span class="line">from sqlalchemy.ext.declarative import declarative_base</span><br><span class="line">from sqlalchemy import ForeignKey</span><br><span class="line">from sqlalchemy import Column, String, Integer, Text</span><br><span class="line">from sqlalchemy.orm import sessionmaker, relationship</span><br><span class="line"></span><br><span class="line">engine = create_engine(&apos;mysql+mysqldb://root@localhost:3306/blog?charset=utf8&apos;)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">class User(Base):</span><br><span class="line">    __tablename__ = &apos;users&apos;</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=True)</span><br><span class="line">    username = Column(String(64), nullable=False, index=True)</span><br><span class="line">    password = Column(String(64), nullable=False)</span><br><span class="line">    email = Column(String(64), nullable=False, index=True)</span><br><span class="line">    articles = relationship(&apos;Article&apos;, backref=&apos;author&apos;)</span><br><span class="line">    userinfo = relationship(&apos;UserInfo&apos;, backref=&apos;user&apos;, uselist=False)</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &apos;&#123;&#125;(&#123;&#125;)&apos;.format(self.__class__.__name__, self.username)</span><br><span class="line"></span><br><span class="line">class UserInfo(Base):</span><br><span class="line">    __tablename__ = &apos;userinfos&apos;</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=True)</span><br><span class="line">    name = Column(String(64))</span><br><span class="line">    qq = Column(String(11))</span><br><span class="line">    phone = Column(String(11))</span><br><span class="line">    link = Column(String(64))</span><br><span class="line">    user_id = Column(Integer, ForeignKey(&apos;users.id&apos;))</span><br><span class="line"></span><br><span class="line"> class Article(Base):</span><br><span class="line">    __tablename__ = &apos;articles&apos;</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=True)</span><br><span class="line">    title = Column(String(255), nullable=False, index=True)</span><br><span class="line">    content = Column(Text)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(&apos;users.id&apos;))</span><br><span class="line">    cate_id = Column(Integer, ForeignKey(&apos;categories.id&apos;))</span><br><span class="line">    tags = relationship(&apos;Tag&apos;, secondary=&apos;article_tag&apos;, backref=&apos;articles&apos;)</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &quot;&#123;&#125;(&#123;&#125;)&quot;.format(self.__class__.__name__, self.title)</span><br><span class="line"></span><br><span class="line">class Category(Base):</span><br><span class="line">    __tablename__ = &apos;categories&apos;</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=True)</span><br><span class="line">    name = Column(String(64), nullable=False, index=True)</span><br><span class="line">    articles = relationship(&apos;Article&apos;, backref=&apos;category&apos;)</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &apos;&#123;&#125;(&#123;&#125;)&apos;.format(self.__class__.__name__, self.name)</span><br><span class="line"></span><br><span class="line">article_tag = Table(</span><br><span class="line">    &apos;article_tag&apos;, Base.metadata,</span><br><span class="line">    Column(&apos;article_id&apos;, Integer, ForeignKey(&apos;article.id&apos;)),</span><br><span class="line">    Column(&apos;tag_id&apos;, Integer, ForeignKey(&apos;tags.id&apos;)),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">class Tag(Base):</span><br><span class="line">    __tablename__ = &apos;tags&apos;</span><br><span class="line"></span><br><span class="line">    id = Column(Integer, primary_key=True)</span><br><span class="line">    name = Column(String(64), nullable=False, index=True)</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &apos;&#123;&#125;(&#123;&#125;)&apos;.format(self.__class__.__name__, self.name)</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    Base.metadata.create_al(engine)</span><br><span class="line"></span><br><span class="line">    faker = Factory.create()</span><br><span class="line">    Session = sessionmaker(bind=engine)</span><br><span class="line">    session = Session()</span><br><span class="line"></span><br><span class="line">    faker_users = [User(username=faker.name(),password=faker.word(),email=faker.email()) for i in range(10)]</span><br><span class="line">    session.add_all(faker_usres)</span><br><span class="line"></span><br><span class="line">    faker_categories = [Category(name=faker.word()) for i in range(5)]</span><br><span class="line">    session.add_all(faker_categories)</span><br><span class="line"></span><br><span class="line">    faker_tags = [Tag(name=faker.word()) for i in range(20)]</span><br><span class="line">    session.add_all(faker_tags)</span><br><span class="line"></span><br><span class="line">    for i in range(100):</span><br><span class="line">        article = Article(title=faker.sentence(), content=&apos; &apos;.join(faker.sentence(nb=random.rendint(10, 20))), author=random.choice(faker_users), category=random.choice(faker_categories))</span><br><span class="line">        for tag in random.sample(faker_tags, randon.randint(2, 5)):</span><br><span class="line">            article.tags.append(tag)</span><br><span class="line">        session.add(article)</span><br><span class="line"></span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/04/03/SQLAlchemy-Example-Create-Database-CURD-Faker/" data-id="cm50h3ra90055yfhtq7r7t2uh" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/04/03/SQLAlchemy-Example-Create-Database-CURD-Faker/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlalchemy/">sqlalchemy</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-RESTful-APIs-with-Tornado" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/01/Building-RESTful-APIs-with-Tornado/" class="article-date">
  <time datetime="2017-04-01T08:36:29.000Z" itemprop="datePublished">2017-04-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tornado/">tornado</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/01/Building-RESTful-APIs-with-Tornado/">Building RESTful APIs with Tornado</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>this blog is forward from <a href="http://www.drdobbs.com/open-source/building-restful-apis-with-tornado/240160382?pgno=1" target="_blank" rel="noopener">here</a></p>
<p>Tornado is a Python Web framework and asynchronous networking library that provides excellent scalability due to its non-blocking network I/O. It also greatly facilitates building a RESTful API quickly. These features are central to Tornado, as it is the open-source version of FriendFeed’s Web server. A few weeks ago, Tornado 3.  was released, and it introduced many improvements. In this article, I show how to build a RESTful API with the latest Tornado Web framework and I illustrate how to take advantage of its asynchronous features.</p>
<h2 id="Mapping-URL-Patterns-to-Request-Handlers"><a href="#Mapping-URL-Patterns-to-Request-Handlers" class="headerlink" title="Mapping URL Patterns to Request Handlers"></a>Mapping URL Patterns to Request Handlers</h2><p>To get going, download the latest stable version and perform a manual installation or execute an automatic installation with pip by running pip install tornado.</p>
<p>To build a RESTful API with Tornado, it is necessary to map URL patterns to your subclasses of tornado.web.RequestHandler, which override the methods to handle HTTP requests to the URL. For example, if you want to handle an HTTP GET request with a synchronous operation, you must create a new subclass of tornado.web.RequestHandler and define the get() method. Then, you map the URL pattern in tornado.web.Application.</p>
<p>Listing One shows a very simple RESTful API that declares two subclasses of tornado.web.RequestHandler that define the get method: VersionHandler and GetGameByIdHandler.</p>
<h2 id="Listing-One-A-simple-RESTful-API-in-Tornado"><a href="#Listing-One-A-simple-RESTful-API-in-Tornado" class="headerlink" title="Listing One: A simple RESTful API in Tornado."></a>Listing One: A simple RESTful API in Tornado.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from datetime import date</span><br><span class="line">import tornado.escape</span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line"> </span><br><span class="line">class VersionHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        response = &#123; &apos;version&apos;: &apos;3.5.1&apos;,</span><br><span class="line">            &apos;last_build&apos;:  date.today().isoformat() &#125;</span><br><span class="line">        self.write(response)</span><br><span class="line"></span><br><span class="line">class GetGameByIdHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self, id):</span><br><span class="line">        response = &#123; &apos;id&apos;: int(id),</span><br><span class="line">            &apos;name&apos;: &apos;Crazy Game&apos;,</span><br><span class="line">            &apos;release_date&apos;: date.today().isoformat() &#125;</span><br><span class="line">        self.write(response)</span><br><span class="line">        </span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (r&quot;/getgamebyid/([0-9]+)&quot;, GetGameByIdHandler),</span><br><span class="line">    (r&quot;/version&quot;, VersionHandler)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    application.listen(8888)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>
<p>The code is easy to understand. It creates an instance of tornado.web.Application named application with the collection of request handlers that make up the Web application. The code passes a list of tuples to the Application constructor. The list is composed of a regular expression (regexp) and a tornado.web.RequestHandler subclass (request_class). The application.listen method builds an HTTP server for the application with the defined rules on the specified port. In this case, the code uses the default 8888 port. Then, the call to tornado.ioloop.IOLoop.instance().start() starts the server created with application.listen.</p>
<p>When the Web application receives a request, Tornado iterates over that list and creates an instance of the first tornado.web.RequestHandler subclass whose associated regular expression matches the request path, and then calls the head(), get(), post(), delete(), patch(), put() or options() method with the corresponding parameters for the new instance based on the HTTP request. For example, Table 1 shows some HTTP requests that match the regular expressions defined in the previous code.</p>
<table>
<thead>
<tr>
<th>HTTP verb and request URL</th>
<th>Tuple (regexp, request_class) that matches the request path</th>
<th>RequestHandler subclass and method that is called</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET <a href="http://localhost:8888/getgamebyid/500" target="_blank" rel="noopener">http://localhost:8888/getgamebyid/500</a></td>
<td>(r”/getgamebyid/([0-9]+)”, GetGameByIdHandler)</td>
<td>GetGameByIdHandler.get</td>
</tr>
<tr>
<td>GET <a href="http://localhost:8888/version" target="_blank" rel="noopener">http://localhost:8888/version</a></td>
<td>(r”/version”, VersionHandler)</td>
<td>VersionHandler.get</td>
</tr>
</tbody>
</table>
<h2 id="Table-1-Matching-HTTP-requests"><a href="#Table-1-Matching-HTTP-requests" class="headerlink" title="Table 1: Matching HTTP requests."></a>Table 1: Matching HTTP requests.</h2><p>The simplest case is the VersionHandler.get method, which just receives self as a parameter because the URL pattern doesn’t include any parameter. The method creates a response dictionary, then calls the self.write method with response as a parameter. The self.write method writes the received chunk to the output buffer. Because the chunk (response) is a dictionary, self.write writes it as JSON and sets the Content-Type of the response to application/json. The following lines show the example response for GET <a href="http://localhost:8888/version" target="_blank" rel="noopener">http://localhost:8888/version</a> and the response headers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;last_build&quot;: &quot;2013-08-08&quot;, &quot;version&quot;: &quot;3.5.1&quot;</span><br><span class="line">Date: Thu, 08 Aug 2013 19:45:04 GMT</span><br><span class="line">Etag: &quot;d733ae69693feb59f735e29bc6b93770afe1684f&quot;</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Server: TornadoServer/3.1</span><br><span class="line">Content-Length: 48&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<p>If you want to send the data with a different Content-Type, you can call the self.set_header with “Content-Type” as the response header name and the desired value for it. You have to call self.set_header after calling self.write, as shown in Listing Two. It sets the Content-Type to text/plain instead of the default application/json in a new version of the VersionHandler class. Tornado encodes all header values as UTF-8.</p>
<h2 id="Listing-Two-Changing-the-content-type"><a href="#Listing-Two-Changing-the-content-type" class="headerlink" title="Listing Two: Changing the content type."></a>Listing Two: Changing the content type.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class VersionHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.write(&quot;Version: 3.5.1. Last build: &quot; + date.today().isoformat())</span><br><span class="line">            self.set_header(&quot;Content-Type&quot;, &quot;text/plain&quot;)</span><br></pre></td></tr></table></figure>
<p>The following lines show the example response for GET <a href="http://localhost:8888/version" target="_blank" rel="noopener">http://localhost:8888/version</a> and the response headers with the new version of the VersionHandler class:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Server: TornadoServer/3.1</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Etag: &quot;c305b564aa650a7d5ae34901e278664d2dc81f37&quot;</span><br><span class="line">Content-Length: 38</span><br><span class="line">Date: Fri, 09 Aug 2013 02:50:48 GMT</span><br></pre></td></tr></table></figure>
<p>The GetGameByIdHandler.get method receives two parameters: self and id. The method creates a response dictionary that includes the integer value received for the id parameter, then calls the self.write method with response as a parameter. The sample doesn’t include any validation for the id parameter in order to keep the code as simple as possible, as I’m focused on the way in which the get method works. I assume you already know how to perform validations in Python. The following lines show the example response for GET <a href="http://localhost:8888/getgamebyid/500" target="_blank" rel="noopener">http://localhost:8888/getgamebyid/500</a> and the response headers:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;release_date&quot;: &quot;2013-08-09&quot;, &quot;id&quot;: 500, &quot;name&quot;: &quot;Crazy Game&quot;&#125;</span><br><span class="line"> </span><br><span class="line"> Content-Length: 63</span><br><span class="line"> Server: TornadoServer/3.1</span><br><span class="line"> Content-Type: application/json; charset=UTF-8</span><br><span class="line"> Etag: &quot;489191987742a29dd10c9c8e90c085bd07a22f0e&quot;</span><br><span class="line"> Date: Fri, 09 Aug 2013 03:17:34 GMT</span><br></pre></td></tr></table></figure>
<p>If you need to access additional request parameters such as the headers and body data, you can access them through self.request. This variable is a tornado.httpserver.HTTPRequest instance that provides all the information about the HTTP request. The HTTPRequest class is defined in httpserver.py.</p>
<h2 id="Working-with-Asynchronous-Code"><a href="#Working-with-Asynchronous-Code" class="headerlink" title="Working with Asynchronous Code"></a>Working with Asynchronous Code</h2><p>If you’ve ever worked with callbacks, you know how difficult it is to read and understand code split into different methods. Tornado provides a generator-based interface (tornado.gen) to enable you to write asynchronous code in handlers in a single generator.</p>
<p>You simply need to use the @tornado.gen.coroutine decorator for asynchronous generators in the required method and you don’t need to add the @tornado.web.asynchronous decorator. Listing Three shows a new subclass of tornado.web.RequestHandler and defines the get() method with the @tornado.gen.coroutine decorator. You need to add two imports to add the code to the previous listing: import tornado.gen and import tornado.httpclient.</p>
<h2 id="Listing-Three-A-different-subclass-of-tornado-web-RequestHandler"><a href="#Listing-Three-A-different-subclass-of-tornado-web-RequestHandler" class="headerlink" title="Listing Three: A different subclass of tornado.web.RequestHandler."></a>Listing Three: A different subclass of tornado.web.RequestHandler.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class GetFullPageAsyncHandler(tornado.web.RequestHandler):</span><br><span class="line">    @tornado.gen.coroutine</span><br><span class="line">    def get(self):</span><br><span class="line">        http_client = tornado.httpclient.AsyncHTTPClient()</span><br><span class="line">        http_response = yield http_client.fetch(&quot;http://www.drdobbs.com/web-development&quot;)</span><br><span class="line">        response = http_response.body.decode().replace(</span><br><span class="line">            &quot;Most Recent Premium Content&quot;, &quot;Most Recent Content&quot;)</span><br><span class="line">        self.write(response)</span><br><span class="line">        self.set_header(&quot;Content-Type&quot;, &quot;text/html&quot;)</span><br></pre></td></tr></table></figure>
<p>Because I’ve added a new subclass of RequestHandler, it is necessary to map the URL pattern in tornado.Web.Application. Listing Four shows the new code that maps the /getfullpage URL to the GetFullPageAsyncHandler.</p>
<h2 id="Listing-Four-Mapping-a-URL-to-a-handler"><a href="#Listing-Four-Mapping-a-URL-to-a-handler" class="headerlink" title="Listing Four: Mapping a URL to a handler."></a>Listing Four: Mapping a URL to a handler.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">application = tornado.web.Application([</span><br><span class="line">    (r&quot;/getfullpage&quot;, GetFullPageAsyncHandler),</span><br><span class="line">    (r&quot;/getgamebyid/([0-9]+)&quot;, GetGameByIdHandler),</span><br><span class="line">    (r&quot;/version&quot;, VersionHandler),            </span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>The GetFullPageAsyncHandler.get method creates a tornado.httpclient.AsyncHTTPClient instance (http_client) that represents a non-blocking HTTP client. Then, the code calls the http_client.fetch method of this instance to asynchronously execute a request. The fetch method returns a Future, whose result is an HTTPResponse, and raises an HTTPError if the request returns a response code other than 200. The code uses the yield keyword to retrieve the HTTPResponse from the Future returned by the fetch method.</p>
<p>The call to fetch retrieves the Dr. Dobb’s Web Development page from <a href="http://www.drdobbs.com/web-development" target="_blank" rel="noopener">http://www.drdobbs.com/web-development</a> with an asynchronous execution. When fetch finishes its execution with a successful response code equal to 200, http_response will be an HTTPRequest instance with the contents of the retrieved HTML page in http_response.body. The method continues its execution with the line after the call to fetch. You have all the code that needs to be executed in the get method with the @tornado.gen.coroutine decorator, and you don’t have to worry about writing a callback for on_fetch. The next line decodes the response body to a string and replaces “Most Recent Premium Content” with “Most Recent Content.” Then, the code calls the self.write method to write the modified string and sets the Content-Type of the response to application/html.</p>
<p>Listing Five is the equivalent code, which uses the @tornado.web.asynchronous decorator instead of @tornado.gen.coroutine. In this case, it is necessary to define the on_fetch method that works as the callback for the http_client.fetch method; therefore, the code is split into two methods.</p>
<h2 id="Listing-Five-The-equivalent-functionality-using-a-decorator"><a href="#Listing-Five-The-equivalent-functionality-using-a-decorator" class="headerlink" title="Listing Five: The equivalent functionality using a decorator."></a>Listing Five: The equivalent functionality using a decorator.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class GetFullPageAsyncNewHandler(tornado.web.RequestHandler):</span><br><span class="line">    @tornado.web.asynchronous</span><br><span class="line">    def get(self):</span><br><span class="line">        http_client = tornado.httpclient.AsyncHTTPClient()</span><br><span class="line">        http_client.fetch(&quot;http://www.drdobbs.com/web-development&quot;, callback=self.on_fetch)</span><br><span class="line"></span><br><span class="line">    def on_fetch(self, http_response):</span><br><span class="line">        if http_response.error: raise tornado.web.HTTPError(500)</span><br><span class="line">        response = http_response.body.decode().replace(&quot;Most Recent Premium Content&quot;, &quot;Most Recent Content&quot;)</span><br><span class="line">        self.write(response)</span><br><span class="line">        self.set_header(&quot;Content-Type&quot;, &quot;text/html&quot;)</span><br><span class="line">        self.finish()</span><br></pre></td></tr></table></figure>
<p>When the fetch method finishes retrieving the content, it executes the code in on_fetch. Because the get method uses @tornado.web.asynchronous, it is your responsibility to call self.finish() to finish the HTTP request. Thus, the on_fetch method calls self_finish in its last line, after calling self.write and self.set_header. As you can see, it is much easier to use the @tornado.gen.coroutine decorator.</p>
<h2 id="Understanding-How-Tornado-Works-with-a-RequestHandler-Subclass"><a href="#Understanding-How-Tornado-Works-with-a-RequestHandler-Subclass" class="headerlink" title="Understanding How Tornado Works with a RequestHandler Subclass"></a>Understanding How Tornado Works with a RequestHandler Subclass</h2><p>The RequestHandler class defines a SUPPORTED_METHODS class variable with the following code. If you need support for different methods, you need to override the SUPPORTED_METHODS class variable in your RequestHandler subclass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUPPORTED_METHODS = (&quot;GET&quot;, &quot;HEAD&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;, &quot;PUT&quot;, &quot;OPTIONS&quot;)</span><br></pre></td></tr></table></figure>
<p>The default code for the head(), get(), post(), delete(), patch(), put(), and options() methods is a single line that raises an HTTPError. Listing Six shows the code for the get method:</p>
<h3 id="Listing-Six-The-get-method"><a href="#Listing-Six-The-get-method" class="headerlink" title="Listing Six: The get() method."></a>Listing Six: The get() method.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def get(self, *args, **kwargs):</span><br><span class="line">   raise HTTPError(405)</span><br></pre></td></tr></table></figure>
<p>Whenever the Web application receives a request and matches the URL pattern, Tornado performs the following actions:</p>
<ol>
<li>It creates a new instance of the RequestHandler subclass that has been mapped to the URL pattern.</li>
<li>It calls the initialize method with the keyword arguments specified in the application configuration. You can override the initialize method to save the arguments into member variables.</li>
<li>No matter what the HTTP request, Tornado calls the prepare method. If you call either finish or send_error, Tornado won’t call any additional methods. You can override the prepare method to execute code that is necessary for any HTTP request, then write your specific code in the head(), get(), post(), delete(), patch(), put() or options() method.</li>
<li>It calls the method according to the HTTP request with the arguments based on the URL regular expression that captured the different groups. As you already know, you must override the methods you want your RequestHandler subclass to be able to process. For example, if there is an HTTP GET request, Tornado will call the get method with the different arguments.</li>
<li>If the handler is synchronous, Tornado calls on_finish after the previous method called, according to the HTTP request returns. But if the handler is asynchronous, Tornado executes on_finish after the code calls finish. The previous asynchronous example showed the usage of finish. You can override the on_finish method to perform cleanup or logging. Notice that Tornado calls on_finish after it sends the response to the client.</li>
</ol>
<p>If the client closes the connection in asynchronous handlers, Tornado calls on_connection_close. You can override this method to clean up resources in this specific scenario. However, the cleanup after processing the request must be included in the on_finish method.</p>
<p>Listing Seven shows a new version of the GetGameByIdHandler class that overrides the initialize method to receive a string specified in the application configuration. The initialize method just saves common_string into a member variable, then the get method uses the string in the response:</p>
<h3 id="Listing-Seven-Overriding-the-initialize-method"><a href="#Listing-Seven-Overriding-the-initialize-method" class="headerlink" title="Listing Seven: Overriding the initialize() method."></a>Listing Seven: Overriding the initialize() method.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class GetGameByIdHandler(tornado.web.RequestHandler):</span><br><span class="line">    def initialize(self, common_string):</span><br><span class="line">        self.common_string = common_string</span><br><span class="line"></span><br><span class="line">    def get(self, id):</span><br><span class="line">        response = &#123; &apos;id&apos;: int(id),</span><br><span class="line">                     &apos;name&apos;: &apos;Crazy Game&apos;,</span><br><span class="line">                     &apos;release_date&apos;: date.today().isoformat(),</span><br><span class="line">                     &apos;common_string&apos;: self.common_string &#125;</span><br><span class="line">        self.write(response)</span><br></pre></td></tr></table></figure>
<p>The following code shows the changes in the arguments passed to the tornado.web.Application constructor to pass a value for common_string in a dictionary for the GetGameByIdHandler request handler:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">application = tornado.web.Application([</span><br><span class="line">    (r&quot;/getgamebyid/([0-9]+)&quot;, GetGameByIdHandler,</span><br><span class="line">    dict(common_string=&apos;Value defined in Application&apos;)),</span><br></pre></td></tr></table></figure>
<p>In this case, I’ve used a simple string as the value passed from the application. However, the most common usage will be to pass one or more common objects (for example, a database object).</p>
<h2 id="Returning-Errors-in-a-Request-Handler"><a href="#Returning-Errors-in-a-Request-Handler" class="headerlink" title="Returning Errors in a Request Handler"></a>Returning Errors in a Request Handler</h2><p>Listing Eight shows the code for the ErrorHandler request handler that demonstrates the simplest use of the three different mechanisms to return errors in a handler method.</p>
<h3 id="Listing-Eight-A-simple-error-request-handler"><a href="#Listing-Eight-A-simple-error-request-handler" class="headerlink" title="Listing Eight: A simple error request handler."></a>Listing Eight: A simple error request handler.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class ErrorHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self, error_code):</span><br><span class="line">        if error_code == 1:</span><br><span class="line">            self.set_status(500)</span><br><span class="line">        elif error_code == 2:</span><br><span class="line">            self.send_error(500)</span><br><span class="line">        else:</span><br><span class="line">            raise tornado.web.HTTPError(500)</span><br></pre></td></tr></table></figure>
<p>It is necessary to add the appropriate mapping to the Application constructor parameters with the following line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(r&quot;/error/([0-9]+)&quot;, ErrorHandler),</span><br></pre></td></tr></table></figure>
<p>If error_code is equal to 1, the get method calls self.set_status, which sets the status code for the response. It is also possible to specify a reason string as the second parameter. If error_code is equal to 2, the get method calls self.send_error, which sends the specified HTTP error code to the browser. Any other error_code value will make the get method raise a tornado.web.HTTPError exception with the 500 status code.</p>
<p>The three different mechanisms to return errors return the default error page, which you can change by overriding the write_error method in your RequestHandler subclasses.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this article, I’ve provided many examples to show how to easy it is to start developing RESTful APIs with Tornado. I’ve covered basic features, but you will definitely want to dive deeper into Tornado’s additional useful features when building a complete RESTful API. Tornado’s source code comes with good documentation for the different methods and variables, so you can easily build the methods you need to use as you write code.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/04/01/Building-RESTful-APIs-with-Tornado/" data-id="cm50h3rab0057yfhtgvfmn4pi" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/04/01/Building-RESTful-APIs-with-Tornado/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tornado/">tornado</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Creating-a-multiprocessing-Downloader-App" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/19/Creating-a-multiprocessing-Downloader-App/" class="article-date">
  <time datetime="2017-03-19T14:26:01.000Z" itemprop="datePublished">2017-03-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/19/Creating-a-multiprocessing-Downloader-App/">Creating a multiprocessing Downloader App</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import multiprocessing</span><br><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">class MultiProcDownloader(object):</span><br><span class="line">    def __init__(self, urls):</span><br><span class="line">        self.urls = urls</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        jobs = []</span><br><span class="line">        for url in self.urls:</span><br><span class="line">            process = multiprocessing.Process(target=self.worker, args=(url,))</span><br><span class="line">            jobs.append(process)</span><br><span class="line">            process.start()</span><br><span class="line">        for job in jobs:</span><br><span class="line">            job.join()</span><br><span class="line"></span><br><span class="line">    def worker(self, url):</span><br><span class="line">        fname = os.path.basename(url)</span><br><span class="line">        msg = &apos;Starting download of %s&apos;%fname</span><br><span class="line">        print(msg, multiprocessing.current_process().name)</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        with open(fname, &apos;wb&apos;) as f:</span><br><span class="line">            f.write(r.content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    urls = [&quot;http://www.irs.gov/pub/irs-pdf/f1040.pdf&quot;,</span><br><span class="line">            &quot;http://www.irs.gov/pub/irs-pdf/f1040a.pdf&quot;,</span><br><span class="line">            &quot;http://www.irs.gov/pub/irs-pdf/f1040ez.pdf&quot;,</span><br><span class="line">            &quot;http://www.irs.gov/pub/irs-pdf/f1040es.pdf&quot;,</span><br><span class="line">            &quot;http://www.irs.gov/pub/irs-pdf/f1040sb.pdf&quot;]</span><br><span class="line">    downloader = MultiProcDownloader(urls)</span><br><span class="line">    downloader.run()</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/03/19/Creating-a-multiprocessing-Downloader-App/" data-id="cm50h3ra6004zyfhtdwmc4l7x" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/03/19/Creating-a-multiprocessing-Downloader-App/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python-201-A-multiprocessing-tutorial" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/18/Python-201-A-multiprocessing-tutorial/" class="article-date">
  <time datetime="2017-03-17T18:31:45.000Z" itemprop="datePublished">2017-03-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/18/Python-201-A-multiprocessing-tutorial/">A multiprocessing tutorial</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>this blog translate from <a href="http://www.blog.pythonlibrary.org/2016/08/02/python-201-a-multiprocessing-tutorial/" target="_blank" rel="noopener">http://www.blog.pythonlibrary.org/2016/08/02/python-201-a-multiprocessing-tutorial/</a></em></p>
<p>The multiprocessing module was added to Python in version 2.6. It was originally defined in PEP 371 by Jesse Noller and Richard Oudkerk. The multiprocessing module allows you to spawn processes in much that same manner than you can spawn threads with the threading module. The idea here is that because you are now spawning processes, you can avoid the Global Interpreter Lock (GIL) and take full advantages of multiple processors on a machine.</p>
<p>The multiprocessing package also includes some APIs that are not in the threading module at all. For example, there is a neat Pool class that you can use to parallelize executing a function across multiple inputs. We will be looking at Pool in a later section. We will start with the multiprocessing module’s Process class.</p>
<h2 id="Getting-started-with-multiprocessing"><a href="#Getting-started-with-multiprocessing" class="headerlink" title="Getting started with multiprocessing"></a>Getting started with multiprocessing</h2><p>The Process class is very similar to the threading module’s Thread class. Let’s try creating a series of processes that call the same function and see how that works:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">from multiprocessing import Process</span><br><span class="line"></span><br><span class="line">def boubler(number):</span><br><span class="line">    result = number * 2</span><br><span class="line">    proc = os.getpid()</span><br><span class="line">    print(&apos;&#123;0&#125; doubled to &#123;1&#125; by process id: &#123;2&#125;&apos;.format(number, result, proc))</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    numbers = [5,10,15,20,25]</span><br><span class="line">    procs = []</span><br><span class="line"></span><br><span class="line">    for index, number in enumerate(numbers):</span><br><span class="line">        proc = Process(target=doubler, args=(number,))</span><br><span class="line">        procs.append(proc)</span><br><span class="line">        proc.start()</span><br><span class="line"></span><br><span class="line">    for proc in procs:</span><br><span class="line">        proc.join()</span><br></pre></td></tr></table></figure>
<p>For this example, we import Process and create a doubler function. Inside the function, we double the number that was passed in. We also use Python’s os module to get the current process’s ID (or pid). This will tell us which process is calling the function. Then in the block of code at the bottom, we create a series of Processes and start them. The very last loop just calls the join() method on each process, which tells Python to wait for the process to terminate. If you need to stop a process, you can call its terminate() method.</p>
<p>When you run this code, you should see output that is similar to the following:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5 doubled to 10 by process id: 10468</span><br><span class="line">10 doubled to 20 by process id: 10469</span><br><span class="line">15 doubled to 30 by process id: 10470</span><br><span class="line">20 doubled to 40 by process id: 10471</span><br><span class="line">25 doubled to 50 by process id: 10472</span><br></pre></td></tr></table></figure></p>
<p>Sometimes it’s nicer to have a more human readable name for your process though. Fortunately, the Process class does allow you to access the same of your process. Let’s take a look:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">from multiprocessing import Process, current_process</span><br><span class="line"></span><br><span class="line">def doubler(number):</span><br><span class="line">    result = number * 2</span><br><span class="line">    proc_name = current_process().name</span><br><span class="line">    print(&apos;&#123;0&#125; doubled to &#123;1&#125; by: &#123;2&#125;&apos;.format(number, result, proc_name))</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    numbers = [5,10,15,20,25]</span><br><span class="line">    procs = []</span><br><span class="line">    proc = Process(target=doubler, args=(5,))</span><br><span class="line"></span><br><span class="line">    for index, number in enumerate(numbers):</span><br><span class="line">        proc = Process(target=doubler, args=(number,))</span><br><span class="line">        procs.append(proc)</span><br><span class="line">        proc.start()</span><br><span class="line"></span><br><span class="line">    proc = Process(target=doubler, name=&apos;Test&apos;, args=(2,))</span><br><span class="line">    proc.start()</span><br><span class="line">    procs.append(proc)</span><br><span class="line"></span><br><span class="line">    for proc in procs:</span><br><span class="line">        proc.join()</span><br></pre></td></tr></table></figure>
<p>This time around, we import something extra: current_process. The current_process is basically the same thing as the threading module’s current_thread. We use it to grab the name of the thread that is calling our function. You will note that for the first five processes, we don’t set a name. Then for the sixth, we set the process name to “Test”. Let’s see what we get for output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">5 doubled to 10 by: Process-2</span><br><span class="line">10 doubled to 20 by: Process-3</span><br><span class="line">15 doubled to 30 by: Process-4</span><br><span class="line">20 doubled to 40 by: Process-5</span><br><span class="line">25 doubled to 50 by: Process-6</span><br><span class="line">2 doubled to 4 by: Test</span><br></pre></td></tr></table></figure>
<p>The output demonstrates that the multiprocessing module assigns a number to each process as a part of its name by default. Of course, when we specify a name, a number isn’t going to get added to it.</p>
<h2 id="Locks"><a href="#Locks" class="headerlink" title="Locks"></a>Locks</h2><p>The multiprocessing module supports locks in much the same way as the threading module does. All you need to do is import Lock, acquire it, do something and release it. Let’s take a look:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from multiprocessing import Process, Lock</span><br><span class="line"></span><br><span class="line">def printer(item, lock):</span><br><span class="line">    lock.actuire()</span><br><span class="line">    try:</span><br><span class="line">        print(item)</span><br><span class="line">    finally:</span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    lock = Lock()</span><br><span class="line">    items = [&apos;tango&apos;, &apos;foxtrot&apos;, 10]</span><br><span class="line">    for item in items:</span><br><span class="line">        p = Process(target=printer, args=(item, lock))</span><br><span class="line">        p.start()</span><br></pre></td></tr></table></figure>
<p>Here we create a simple printing function that prints whatever you pass to it. To prevent the threads from interfering with each other, we use a Lock object. This code will loop over our list of three items and create a process for each of them. Each process will call our function and pass it one of the items from the iterable. Because we’re using locks, the next process in line will wait for the lock to release before it can continue.</p>
<h2 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h2><p>Logging processes is a little different than logging threads. The reason for this is that Python’s logging packages doesn’t use process shared locks, so it’s possible for you to end up with messages from different processes getting mixed up. Let’s try adding basic logging to the previous example. Here’s the code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line">import multiprocessing</span><br><span class="line"></span><br><span class="line">from multiprocessing import Process, Lock</span><br><span class="line"></span><br><span class="line">def printer(item, lock):</span><br><span class="line">    lock.acquire()</span><br><span class="line">    try:</span><br><span class="line">        print(item)</span><br><span class="line">    finally:</span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    lock = Lock()</span><br><span class="line">    items = [&apos;tango&apos;, &apos;foxtrot&apos;, 10]</span><br><span class="line">    multiprocessing.log_to_stderr()</span><br><span class="line">    logger = multiprocessing.get_logger()</span><br><span class="line">    logger.setLevel(logging.INFO)</span><br><span class="line">    for item in items:</span><br><span class="line">        p = Process(targe=printer, args=(item, lock))</span><br><span class="line">        p.start()</span><br></pre></td></tr></table></figure>
<p>The simplest way to log is to send it all to stderr. We can do this by calling the log_to_stderr() function. Then we call the get_logger function to get access to a logger and set its logging level to INFO. The rest of the code is the same. I will note that I’m not calling the join() method here. Instead, the parent thread (i.e. your script) will call join() implicitly when it exits.</p>
<p>When you do this, you should get output like the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[INFO/Process-1] child process calling self.run()</span><br><span class="line">tango</span><br><span class="line">[INFO/Process-1] process shutting down</span><br><span class="line">[INFO/Process-1] process exiting with exitcode 0</span><br><span class="line">[INFO/Process-2] child process calling self.run()</span><br><span class="line">[INFO/MainProcess] process shutting down</span><br><span class="line">foxtrot</span><br><span class="line">[INFO/Process-2] process shutting down</span><br><span class="line">[INFO/Process-3] child process calling self.run()</span><br><span class="line">[INFO/Process-2] process exiting with exitcode 0</span><br><span class="line">10</span><br><span class="line">[INFO/MainProcess] calling join() for process Process-3</span><br><span class="line">[INFO/Process-3] process shutting down</span><br><span class="line">[INFO/Process-3] process exiting with exitcode 0</span><br><span class="line">[INFO/MainProcess] calling join() for process Process-2</span><br></pre></td></tr></table></figure>
<p>Now if you want to save the log to disk, then it gets a little trickier. You can read about that topic in Python’s logging Cookbook.</p>
<h2 id="The-Pool-Class"><a href="#The-Pool-Class" class="headerlink" title="The Pool Class"></a>The Pool Class</h2><p>The Pool class is used to represent a pool of worker processes. It has methods which can allow you to offload tasks to the worker processes. Let’s look at a really simple example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from multiprocessing import Pool</span><br><span class="line"></span><br><span class="line">def doubler(number):</span><br><span class="line">    return number * 2</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    numbers = [5,10,20]</span><br><span class="line">    pool = Pool(processes=3)</span><br><span class="line">    print(pool.map(doubler, numbers))</span><br></pre></td></tr></table></figure>
<p>Basically what’s happening here is that we create an instance of Pool and tell it to create three worker processes. Then we use the map method to map a function and an iterable to each process. Finally we print the result, which in this case is actually a list: [10, 20, 40].</p>
<p>You can also get the result of your process in a pool by using the apply_async method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from multiprocessing import Pool</span><br><span class="line"></span><br><span class="line">def doubler(num):</span><br><span class="line">    return num * 2</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    pool = Pool(processes=3)</span><br><span class="line">    result = pool.apply_async(doubler, (25,))</span><br><span class="line">    print(result.get(timeout=1))</span><br></pre></td></tr></table></figure>
<p>What this allows us to do is actually ask for the result of the process. That is what the get function is all about. It tries to get our result. You will note that we also have a timeout set just in case something happened to the function we were calling. We don’t want it to block indefinitely after all.</p>
<h2 id="Process-Communication"><a href="#Process-Communication" class="headerlink" title="Process Communication"></a>Process Communication</h2><p>When it comes to communicating between processes, the multiprocessing modules has two primary methods: Queues and Pipes. The Queue implementation is actually both thread and process safe. Let’s take a look at a fairly simple example that’s based on the Queue code from one of my threading articles:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from multiprocessing import Process, Queue</span><br><span class="line"></span><br><span class="line">setinel = -1</span><br><span class="line"></span><br><span class="line">def creator(data, q):</span><br><span class="line">    print(&apos;Creating data and putting it on the queue&apos;)</span><br><span class="line">    for item in data:</span><br><span class="line">        q.put(item)</span><br><span class="line"></span><br><span class="line">def my_consumer(q):</span><br><span class="line">    while True:</span><br><span class="line">        data = q.get()</span><br><span class="line">        print(&apos;data found to be processed: &#123;&#125;&apos;.format(data))</span><br><span class="line">        processed = data * 2</span><br><span class="line">        print(processed)</span><br><span class="line">        if data is sentinel:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">if __name__==&apos;__main__&apos;:</span><br><span class="line">    q = Queue()</span><br><span class="line">    data = [5,10,13,-1]</span><br><span class="line">    process_one = Process(target=creator, args=(data, q))</span><br><span class="line">    process_two = Process(target=my_consumer, args=(q,))</span><br><span class="line">    process_one.start()</span><br><span class="line">    process_two.start()</span><br><span class="line"></span><br><span class="line">    q.close()</span><br><span class="line">    q.join_thread()</span><br><span class="line"></span><br><span class="line">    process_one.join()</span><br><span class="line">    process_two.join()</span><br></pre></td></tr></table></figure>
<p>Here we just need to import Queue and Process. Then we two functions, one to create data and add it to the queue and the second to consume the data and process it. Adding data to the Queue is done by using the Queue’s put() method whereas getting data from the Queue is done via the get method. The last chunk of code just creates the Queue object and a couple of Processes and then runs them. You will note that we call join() on our process objects rather than the Queue itself.</p>
<h2 id="Wrapping-Up"><a href="#Wrapping-Up" class="headerlink" title="Wrapping Up"></a>Wrapping Up</h2><p>We have a lot of material here. You have learned how to use the multiprocessing module to target regular functions, communicate between processes using Queues, naming threads and much more. There is also a lot more in the Python documentation that isn’t even touched in this article, so be sure to dive into that as well. In the meantime, you now know how to utilize all your computer’s processing power with Python!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/03/18/Python-201-A-multiprocessing-tutorial/" data-id="cm50h3ra70051yfht47yutm2q" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/03/18/Python-201-A-multiprocessing-tutorial/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-simple-workflow-engine-in-Python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/17/Building-a-simple-workflow-engine-in-Python/" class="article-date">
  <time datetime="2017-03-17T15:45:02.000Z" itemprop="datePublished">2017-03-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/17/Building-a-simple-workflow-engine-in-Python/">Building a simple workflow engine in Python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>this blog translate from <a href="http://supercoderz.in/building-a-simple-workflow-engine-in-python/" target="_blank" rel="noopener">http://supercoderz.in/building-a-simple-workflow-engine-in-python/</a></em></p>
<p>In my last post I described how a workflow engine works and the various key parts of a workflow engine. In this post I will show you how to build  simple workflow engine in Python. This will be built in Python using the django framework.</p>
<p>Read on to find out more - It would be recommended to get an overview of django framework if you plan to download the code and try this out. I will not be going into the details of how to setup django and the internals.</p>
<h2 id="The-basic-idea"><a href="#The-basic-idea" class="headerlink" title="The basic idea"></a>The basic idea</h2><p>The idea of this post is to show a simple workflow engine. We will build a workflow engine that can take a process and a set of tasks associated with the process in a given sequence and execute the tasks. The tasks can be code tasks which have a piece of Python code that would be executed, or manual tasks which would require someone to approve the task.<br>The work of creating the tasks and storing them somewhere in a DB will be handled by django. django is a web development framework for Python that makes building web applications very easy. The django admin application which comes bundled with the framework make it very trivial to create simple CRUD web pages for databases.</p>
<p>The workflow engine that takes tasks and either executes them or queues them for approval is written as a django custom function so that it can be easily invoked with access to all the database models.</p>
<p>Starting a new process and approving a task - since this a demo application to show how the workflow engine works, I did not build a UI for these tasks. These are also built as custom django commands. But you can easily build some sort of a simple django page for these with very less effort.</p>
<p>The code for this can be accessed from - <a href="http://krishna.lifeandit.com" target="_blank" rel="noopener">http://krishna.lifeandit.com</a></p>
<h2 id="The-Models"><a href="#The-Models" class="headerlink" title="The Models"></a>The Models</h2><p>Any workflow engine has a DB model to maintain the relationships between the processes, tasks and the various states. We will have three main entities - Process, Task and TaskTransitions. TaskTransitions will be responsible for maintaining the relationship between a task and the process that it is part of. This will also contain details about where the task occurs in that process  in the form of a sequence number.</p>
<p>Apart from this, there will be two tables to maintain a list of running processes and a list of tasks waiting for approval.</p>
<p>These models are defined as shown below</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line">class Process(models.Model):</span><br><span class="line">    name = models.CharField(max_length=200)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.name</span><br><span class="line"></span><br><span class="line">class Task(models.Model):</span><br><span class="line">    name=models.CharField(max_length=200)</span><br><span class="line">    manual=models.BooleanField()</span><br><span class="line">    parent=models.ForeignKey(Process)</span><br><span class="line">    code=models.CharField(max_length=2000)</span><br><span class="line">    approver=models.CharField(max_length=200)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.name</span><br><span class="line"></span><br><span class="line">class TaskTransitions(models.Model):</span><br><span class="line">    process=models.ForeignKey(Process)</span><br><span class="line">    task=models.ForeignKey(Task)</span><br><span class="line">    sequence=models.IntegerField()</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.process.name + str(self.sequence)</span><br><span class="line"></span><br><span class="line">class RunningProcesses(models.Model):</span><br><span class="line">    process=models.ForeignKey(Process)</span><br><span class="line">    state=models.CharField(max_length=200)</span><br><span class="line">    step=models.IntegerField()</span><br><span class="line"></span><br><span class="line">class WaitingForApproval(models.Model):</span><br><span class="line">    process=models.ForeignKey(Process)</span><br><span class="line">    task=models.ForeignKey(Task)</span><br><span class="line">    rpid=models.IntegerField()</span><br></pre></td></tr></table></figure>
<p>Once these models are defines, you can easily create tasks in the django admin page. If you are downloading the code for this, then please edit the djnago settings.py file and point to a database of your choice. Then run ‘python manage.py syncdb’ to create all the tables and ‘python manage.py runserver’ to start the server. You can browse to the django admin page at <a href="http://localhost:8000/admin" target="_blank" rel="noopener">http://localhost:8000/admin</a> and login with the user ID that you created while doing syncdb. You should be able to create some process, tasks and define the relationships between them.</p>
<h2 id="The-Engine"><a href="#The-Engine" class="headerlink" title="The Engine"></a>The Engine</h2><p>The workflow engine needs to have three parts, one to create a running instance of a process, one to approve a task and one to actually run through the processes and execute them. We will build these using django models to easily access the database.</p>
<p>For creating a running instance of a process definition, we just need to make an entry in the running processes table. This can be done very easily as shown here</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from django.core.management.base import BaseCommand, CommandError</span><br><span class="line">from krlshna.workflow.models import *</span><br><span class="line"></span><br><span class="line">class Command(BaseCommand):</span><br><span class="line">    args = &apos;&lt;process name&gt;&lt;process name&gt;...&apos;</span><br><span class="line">    help = &apos;Start the specified processes&apos;</span><br><span class="line"></span><br><span class="line">    def handler(self, *args, **kwargs):</span><br><span class="line">        for process_name in args:</span><br><span class="line">            p = Process.objects.get(name=process_name)</span><br><span class="line">            r = RunningProcesses(process=p, state=&apos;READY&apos;, step=0)</span><br><span class="line">            r.save()</span><br></pre></td></tr></table></figure>
<p>On similar lines, approving the tasks can be done as follows - note that here the code approves all instances of that task in the process - there is no ability to approve on a per process instance basis - this can be built on top easily.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from django.core.management.base import BaseCommand, CommandError</span><br><span class="line">from krishna.workflow.models import *</span><br><span class="line"></span><br><span class="line">class Command(BaseCommand):</span><br><span class="line">    args = &apos;&lt;process name&gt;&lt;task name&gt;&apos;</span><br><span class="line">    help = &apos;Approve the given task in the specified process&apos;</span><br><span class="line"></span><br><span class="line">    def handle(self, *args, **kwargs):</span><br><span class="line">        process_name = args[0]</span><br><span class="line">        task_name = args[1]</span><br><span class="line">        p = Process.objects.get(name=process_name)</span><br><span class="line">        t = Task.objects.get(name=task_name)</span><br><span class="line">        approvals = WaitingForApproval.objects.filter(process=p, task=t)</span><br><span class="line">        for approval in approvals:</span><br><span class="line">            approval.task.approved = True</span><br><span class="line">            approval.task.save()</span><br><span class="line">            rp = RunningProcesses.objects.get(id=approval.rpid)</span><br><span class="line">            rp.state = &apos;READY&apos;</span><br><span class="line">            rp.step = rp.step + 1</span><br><span class="line">            rp.save()</span><br><span class="line">            approval.delete()</span><br></pre></td></tr></table></figure>
<p>The workflow engine itself has a very simple mandate - look for all entries in the running process table with state as READY - these are either newly inserted instances or executing processes. Take the process name and the current step from here and get the corresponding task. If this task is a code task then execute it and increment the step number in the running process table. Manual tasks are added to another table and the state of the process instance is set to WAITING. Once approved, the state will be set to READY and the step number incremented.  This entire flow runs in a loop with a 10 second sleep between each run. In each run, it executes one step from any given process.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from django.core.management.base import BaseCommand, CommandError</span><br><span class="line">from krishna.workflow.models import *</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">class Command(BaseCommand):</span><br><span class="line">    args = &apos;No arguments&apos;</span><br><span class="line">    help = &apos;Start the workflow engine so that it can run the processes&apos;</span><br><span class="line"></span><br><span class="line">    def handle(self, *args, **kwargs):</span><br><span class="line">        while True:</span><br><span class="line">            rprocesses = RunningProcesses.objects.filter(state=&apos;READY&apos;)</span><br><span class="line">            for rprocess in rprocesses:</span><br><span class="line">                try:</span><br><span class="line">                    p = rprocess.process</span><br><span class="line">                    seq = rprocess.step</span><br><span class="line">                    tr = TaskTransitions.objects.get(process=p.sequence=seq)</span><br><span class="line">                    t = tr.task</span><br><span class="line">                    if t.manual:</span><br><span class="line">                        w = WaitingForApprove(process=p, task=t, rpid=rprocess.id)</span><br><span class="line">                        w.save()</span><br><span class="line">                        rprocess.state = &apos;WAITING&apos;</span><br><span class="line">                        rprocess.save()</span><br><span class="line">                    else:</span><br><span class="line">                        res = eval(t.code)</span><br><span class="line">                        print(&apos;Result of &#123;&#125; task &#123;&#125; is &#123;&#125;&apos;.format(p.name, t.name, res))</span><br><span class="line">                        rprocess.step = rprocess.step + 1</span><br><span class="line">                        rprocess.save()</span><br><span class="line">                except:</span><br><span class="line">                    pass</span><br><span class="line">            time.sleep(10)</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This code illustrates a very simple workflow - this cannot be used in a real life scenario without adding more states, more easy ways to define processes, start process or approve processes from a UI. Also this would need to support some sort of a process definition standard like BPEL and derieve the processes and tasks from that. But this is a good exercise to prove the basics.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/03/17/Building-a-simple-workflow-engine-in-Python/" data-id="cm50h3ra5004xyfhtxaqgafia" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/03/17/Building-a-simple-workflow-engine-in-Python/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-django-celery-simple-use" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/16/django-celery-simple-use/" class="article-date">
  <time datetime="2017-01-16T15:41:46.000Z" itemprop="datePublished">2017-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/django/">django</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/16/django-celery-simple-use/">django-celery simple use</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Install-celery-django-django-celery-reids"><a href="#Install-celery-django-django-celery-reids" class="headerlink" title="Install celery, django, django-celery, reids"></a>Install celery, django, django-celery, reids</h1><h1 id="Django-settings-py"><a href="#Django-settings-py" class="headerlink" title="Django settings.py"></a>Django settings.py</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    &apos;djcelery&apos;,</span><br><span class="line">    &apos;app1&apos;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import djcelery</span><br><span class="line">djcelery.setup_loader()</span><br><span class="line"></span><br><span class="line">BROKER_URL = &apos;redis://127.0.0.1:6379/0&apos;</span><br><span class="line">CELERY_IMPORTS = (&apos;app1.task&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="Create-task-py-in-app1-folder"><a href="#Create-task-py-in-app1-folder" class="headerlink" title="Create task.py in app1 folder"></a>Create task.py in app1 folder</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">from celery import task</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">def sendmail(mail):</span><br><span class="line">    print(&apos;sending mail to %s...&apos; % mail[&apos;to&apos;])</span><br><span class="line">    time.sleep(2.0)</span><br><span class="line">    print(&apos;mail sent.&apos;)</span><br><span class="line">    return mail[&apos;to&apos;]</span><br></pre></td></tr></table></figure>
<h1 id="Run-Redis"><a href="#Run-Redis" class="headerlink" title="Run Redis"></a>Run Redis</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>
<p>or running redis in backend</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup redis-server&amp;</span><br></pre></td></tr></table></figure>
<h1 id="Run-celery-worker"><a href="#Run-celery-worker" class="headerlink" title="Run celery worker"></a>Run celery worker</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py celery worker --loglevel=info -c 4</span><br></pre></td></tr></table></figure>
<p>or running in backend<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python manage.py celery worker --loglevel=info -c 4</span><br></pre></td></tr></table></figure></p>
<h1 id="Add-celery-in-supervisor"><a href="#Add-celery-in-supervisor" class="headerlink" title="Add celery in supervisor"></a>Add celery in supervisor</h1><p>In supervisor config file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[program:celery]</span><br><span class="line">command=python manage.py celery worker -c 4 --loglevel=info</span><br><span class="line">directory=/data/integratedmanagement/</span><br><span class="line">user=lanshi</span><br><span class="line">redirect_stderr=true</span><br><span class="line">autostart=true</span><br><span class="line">stdout_logfile=/tmp/youjian_celery.log</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2017/01/16/django-celery-simple-use/" data-id="cm50h3ra2004syfhtq9bmtykh" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2017/01/16/django-celery-simple-use/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/django-celery/">django-celery</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-configuring-and-running-django--celery-in-docker-containers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/22/configuring-and-running-django--celery-in-docker-containers/" class="article-date">
  <time datetime="2016-11-21T16:00:00.000Z" itemprop="datePublished">2016-11-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/django/">django</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/22/configuring-and-running-django--celery-in-docker-containers/">Configuring and Running Django + Celery in Docker Containers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>After reading this blog post, you will be able to configure Celery with Django, PostgreSQL, Redis, and RabbitMQ, and then run everything in Docker containers.</em></p>
<p>This blog translated from <a href="https://www.syncano.io/blog/configuring-running-django-celery-docker-containers-pt-1/" target="_blank" rel="noopener">here</a></p>
<p>Today, you’ll learn how to set up a distributed task processing system for quick prototyping. You will configure Celery with Django, PostgreSQL, Redis, and RabbitMQ, and then run everything in Docker containers. You’ll need some working knowledge of <a href="http://www.docker.com/" target="_blank" rel="noopener">Docker</a> for this tutorial, which you can get in one my previous posts <a href="https://www.syncano.io/blog/getting-started-with-docker/" target="_blank" rel="noopener">here</a>.</p>
<p><a href="https://www.djangoproject.com/" target="_blank" rel="noopener">Django</a> is a well-known Python web framework, and <a href="https://celery.readthedocs.org/en/latest/" target="_blank" rel="noopener">Celery</a> is a distributed task queue. You’ll use PostgreSQL as a regular database to store jobs, RabbitMQ as message broker, and Redis as a task storage backend.</p>
<h1 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h1><p>When you build a web application, sooner or later you’ll have to implement some kind of offline task processing.</p>
<p><strong>Example:</strong></p>
<blockquote>
<p>Alice wants to convert her cat photos from .jpg to .png or create a .pdf from her collection of .jpg cat files. Doing either of these tasks in one HTTP request will take too long to execute and will unnecessarily burden the web server - meaning we can’t serve other requests at the same time. The common solution is to execute the task in the background - often on another machine - and poll for the result.  </p>
</blockquote>
<p>A simple setup for an offline task processing could look like this:</p>
<blockquote>
<ol>
<li>Alice uploads a picture.  </li>
<li>Web server schedules job on worker.  </li>
<li>Worker gets job and converts photo.  </li>
<li>Worker creates some result of the task (in this case, a converted photo).  </li>
<li>Web browser polls for the result.  </li>
<li>Web browser gets the result from the server.  </li>
</ol>
</blockquote>
<p>This setup looks clear, but it has a serious flaw - it doesn’t scale well. What if Alice has a lot of cat pictures and one server wouldn’t be enough to process them all at once? Or, if there was some other very big job and all other jobs would be blocked by it? Does she care if all of the images are processed at once? What if processing fails at some point?</p>
<p>Frankly, there is a solution that won’t kill your machine every time you get a bigger selection of images. You need something between the web server and worker: a broker. The web server would schedule new tasks by communicating with the broker, and the broker would communicate with workers to actually execute these tasks. You probably also want to buffer your tasks, retry if they fail, and monitor how many of them were processed.</p>
<p>You would have to create queues for tasks with different priorities, or for those suitable for different kinds of workers.</p>
<p>All of this can be greatly simplified by using Celery - an open-source, distributed tasks queue. It works like a charm after you configure it - as long as you do so correctly.</p>
<h1 id="How-Celery-is-built"><a href="#How-Celery-is-built" class="headerlink" title="How Celery is built"></a>How Celery is built</h1><p>Celery consists of:</p>
<ul>
<li>Tasks, as defined in your app</li>
<li>A broker that routes tasks to workers and queues</li>
<li>Workers doing the actual work</li>
<li>A storage backend</li>
</ul>
<p>You can watch a more in-depth introduction to Celery <a href="https://www.youtube.com/watch?v=3cyq5DHjymw" target="_blank" rel="noopener">here</a> or jump straight to Celery’s getting started guide.</p>
<h1 id="Your-setup"><a href="#Your-setup" class="headerlink" title="Your setup"></a>Your setup</h1><p>Start with the standard Django project structure. It can be created with django-admin, by running in shell:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ django-admin startproject myproject</span><br></pre></td></tr></table></figure>
<p>Which creates a project structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── myproject</span><br><span class="line">    ├── manage.py</span><br><span class="line">    └── myproject</span><br><span class="line">        ├── __init__.py</span><br><span class="line">        ├── settings.py</span><br><span class="line">        ├── urls.py</span><br><span class="line">        └── wsgi.py</span><br></pre></td></tr></table></figure>
<p>At the end of this tutorial, it’ll look like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── myproject</span><br><span class="line">│   ├── manage.py</span><br><span class="line">│   └── myproject</span><br><span class="line">│       ├── celeryconf.py</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       ├── models.py</span><br><span class="line">│       ├── serializers.py</span><br><span class="line">│       ├── settings.py</span><br><span class="line">│       ├── tasks.py</span><br><span class="line">│       ├── urls.py</span><br><span class="line">│       ├── views.py</span><br><span class="line">│       └── wsgi.py</span><br><span class="line">├── requirements.txt</span><br><span class="line">├── run_celery.sh</span><br><span class="line">└── run_web.sh</span><br></pre></td></tr></table></figure>
<h1 id="Creating-containers"><a href="#Creating-containers" class="headerlink" title="Creating containers"></a>Creating containers</h1><p>Since we are working with <a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener">Docker 1.12</a>, we need a proper Dockerfile to specify how our image will be built.</p>
<h2 id="Custom-container"><a href="#Custom-container" class="headerlink" title="Custom container"></a>Custom container</h2><p><strong>Dockerfile</strong></p>
<blockquote>
<p>#use base python image with python 2.7</p>
</blockquote>
<blockquote>
<p>FROM python:2.7</p>
</blockquote>
<blockquote>
<p>#add requirements.txt to the image</p>
</blockquote>
<blockquote>
<p>ADD requirements.txt /app/requirements.txt</p>
</blockquote>
<blockquote>
<p>#set working directory to /app/</p>
</blockquote>
<blockquote>
<p>WORKDIR /app/</p>
</blockquote>
<blockquote>
<p>#install python dependencies</p>
</blockquote>
<blockquote>
<p>RUN pip install -r requirements.txt</p>
</blockquote>
<blockquote>
<p>#create unprivileged user</p>
</blockquote>
<blockquote>
<p>RUN adduser –disabled-password –gecos ‘’ myuser  </p>
</blockquote>
<p>Our dependencies are:</p>
<p><strong>requirements.txt</strong></p>
<blockquote>
<p>Django==1.9.8<br>celery==3.1.20<br>djangorestframework==3.3.1<br>psycopg2==2.5.3<br>redis==2.10.5  </p>
</blockquote>
<p>I’ve frozen versions of dependencies to make sure that you will have a working setup. If you wish, you can update any of them, but it’s not guaranteed to work.</p>
<h2 id="Choosing-images-for-services"><a href="#Choosing-images-for-services" class="headerlink" title="Choosing images for services"></a>Choosing images for services</h2><p>Now we only need to set up RabbitMQ, PostgreSQL, and Redis. Since Docker introduced its official library, I use its official images whenever possible. However, even these can be broken sometimes. When that happens, you’ll have to use something else.</p>
<p>Here are images I tested and selected for this project:</p>
<blockquote>
<p><a href="https://github.com/docker-library/official-images" target="_blank" rel="noopener">Official PostgreSQL image</a><br><a href="https://registry.hub.docker.com/_/redis/" target="_blank" rel="noopener">Official Redis image</a><br><a href="https://hub.docker.com/_/rabbitmq/" target="_blank" rel="noopener">Official RabbitMQ image</a></p>
</blockquote>
<h2 id="Using-docker-compose-to-set-up-a-multicontainer-app"><a href="#Using-docker-compose-to-set-up-a-multicontainer-app" class="headerlink" title="Using docker-compose to set up a multicontainer app"></a>Using docker-compose to set up a multicontainer app</h2><p>Now you’ll use <a href="https://docs.docker.com/compose/" target="_blank" rel="noopener">docker-compose</a> to combine your own containers with the ones we chose in the last section.</p>
<p><strong>docker-compose.yml</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:  </span><br><span class="line">  # PostgreSQL database</span><br><span class="line">  db:</span><br><span class="line">    image: postgres:9.4</span><br><span class="line">    hostname: db</span><br><span class="line">    environment:</span><br><span class="line">      - POSTGRES_USER=postgres</span><br><span class="line">      - POSTGRES_PASSWORD=postgres</span><br><span class="line">      - POSTGRES_DB=postgres</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432:5432&quot;</span><br><span class="line"></span><br><span class="line">  # Redis</span><br><span class="line">  redis:</span><br><span class="line">    image: redis:2.8.19</span><br><span class="line">    hostname: redis</span><br><span class="line"></span><br><span class="line">  # RabbitMQ</span><br><span class="line">  rabbit:</span><br><span class="line">    hostname: rabbit</span><br><span class="line">    image: rabbitmq:3.6.0</span><br><span class="line">    environment:</span><br><span class="line">      - RABBITMQ_DEFAULT_USER=admin</span><br><span class="line">      - RABBITMQ_DEFAULT_PASS=mypass</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5672:5672&quot;  # we forward this port because it&apos;s useful for debugging</span><br><span class="line">      - &quot;15672:15672&quot;  # here, we can access rabbitmq management plugin</span><br><span class="line"></span><br><span class="line">  # Django web server</span><br><span class="line">  web:</span><br><span class="line">    build:</span><br><span class="line">      context: .</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    hostname: web</span><br><span class="line">    command: ./run_web.sh</span><br><span class="line">    volumes:</span><br><span class="line">      - .:/app  # mount current directory inside container</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line">  # set up links so that web knows about db, rabbit and redis</span><br><span class="line">  links:</span><br><span class="line">    - db</span><br><span class="line">    - rabbit</span><br><span class="line">    - redis</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line"></span><br><span class="line">  # Celery worker</span><br><span class="line">  worker:</span><br><span class="line">  build:</span><br><span class="line">  context: .</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    command: ./run_celery.sh</span><br><span class="line">    volumes:</span><br><span class="line">      - .:/app</span><br><span class="line">    links:</span><br><span class="line">      - db</span><br><span class="line">      - rabbit</span><br><span class="line">      - redis</span><br><span class="line">    depends_on:</span><br><span class="line">      - rabbit</span><br></pre></td></tr></table></figure></p>
<h1 id="Configuring-the-web-server-and-worker"><a href="#Configuring-the-web-server-and-worker" class="headerlink" title="Configuring the web server and worker"></a>Configuring the web server and worker</h1><p>You’ve probably noticed that both the worker and web server run some starting scripts. Here they are (make sure they’re executable):</p>
<p><strong>run_web.sh</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"># wait for PSQL server to start</span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">cd myproject  </span><br><span class="line"># prepare init migration</span><br><span class="line">su -m myuser -c &quot;python manage.py makemigrations myproject&quot;  </span><br><span class="line"># migrate db, so we have the latest db schema</span><br><span class="line">su -m myuser -c &quot;python manage.py migrate&quot;  </span><br><span class="line"># start development server on public ip interface, on port 8000</span><br><span class="line">su -m myuser -c &quot;python manage.py runserver 0.0.0.0:8000&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>run_celery.sh</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"># wait for RabbitMQ server to start</span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">cd myproject  </span><br><span class="line"># run Celery worker for our project myproject with Celery configuration stored in Celeryconf</span><br><span class="line">su -m myuser -c &quot;celery worker -A myproject.celeryconf -Q default -n default@%h&quot;</span><br></pre></td></tr></table></figure></p>
<p>The first script - <strong>run_web.sh</strong> - will migrate the database and start the Django development server on port 8000.</p>
<p>The second one , <strong>run_celery.sh</strong>, will start a Celery worker listening on a queue default.</p>
<p>At this stage, these scripts won’t work as we’d like them to because we haven’t yet configured them. Our app still doesn’t know that we want to use PostgreSQL as the database, or where to find it (in a container somewhere). We also have to configure Redis and RabbitMQ.</p>
<p>But before we get to that, there are some useful Celery settings that will make your system perform better. Below are the complete settings of this Django app.</p>
<p><strong>myproject/settings.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">from kombu import Exchange, Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line"># SECURITY WARNING: keep the secret key used in production secret!</span><br><span class="line">SECRET_KEY = &apos;megg_yej86ln@xao^+)it4e&amp;amp;ueu#!4tl9p1h%2sjr7ey0)m25f&apos;</span><br><span class="line"></span><br><span class="line"># SECURITY WARNING: don&apos;t run with debug turned on in production!</span><br><span class="line">DEBUG = True  </span><br><span class="line">TEMPLATE_DEBUG = True  </span><br><span class="line">ALLOWED_HOSTS = []</span><br><span class="line"></span><br><span class="line"># Application definition</span><br><span class="line"></span><br><span class="line">INSTALLED_APPS = (  </span><br><span class="line">    &apos;rest_framework&apos;,</span><br><span class="line">    &apos;myproject&apos;,</span><br><span class="line">    &apos;django.contrib.sites&apos;,</span><br><span class="line">    &apos;django.contrib.staticfiles&apos;,</span><br><span class="line"></span><br><span class="line">    # required by Django 1.9</span><br><span class="line">    &apos;django.contrib.auth&apos;,</span><br><span class="line">    &apos;django.contrib.contenttypes&apos;,</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">MIDDLEWARE_CLASSES = (  </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;  </span><br><span class="line">    &apos;DEFAULT_PERMISSION_CLASSES&apos;: (&apos;rest_framework.permissions.AllowAny&apos;,),</span><br><span class="line">    &apos;PAGINATE_BY&apos;: 10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ROOT_URLCONF = &apos;myproject.urls&apos;</span><br><span class="line"></span><br><span class="line">WSGI_APPLICATION = &apos;myproject.wsgi.application&apos;</span><br><span class="line"></span><br><span class="line"># Localization ant timezone settings</span><br><span class="line"></span><br><span class="line">TIME_ZONE = &apos;UTC&apos;  </span><br><span class="line">USE_TZ = True</span><br><span class="line"></span><br><span class="line">CELERY_ENABLE_UTC = True  </span><br><span class="line">CELERY_TIMEZONE = &quot;UTC&quot;</span><br><span class="line"></span><br><span class="line">LANGUAGE_CODE = &apos;en-us&apos;  </span><br><span class="line">USE_I18N = True  </span><br><span class="line">USE_L10N = True</span><br><span class="line"></span><br><span class="line"># Static files (CSS, JavaScript, Images)</span><br><span class="line"># https://docs.djangoproject.com/en/1.7/howto/static-files/</span><br><span class="line">STATIC_URL = &apos;/static/&apos;</span><br><span class="line"></span><br><span class="line"># Database Condocker-composeuration</span><br><span class="line">DATABASES = &#123;  </span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.postgresql_psycopg2&apos;,</span><br><span class="line">        &apos;NAME&apos;: os.environ.get(&apos;DB_ENV_DB&apos;, &apos;postgres&apos;),</span><br><span class="line">        &apos;USER&apos;: os.environ.get(&apos;DB_ENV_POSTGRES_USER&apos;, &apos;postgres&apos;),</span><br><span class="line">        &apos;PASSWORD&apos;: os.environ.get(&apos;DB_ENV_POSTGRES_PASSWORD&apos;, &apos;postgres&apos;),</span><br><span class="line">        &apos;HOST&apos;: os.environ.get(&apos;DB_PORT_5432_TCP_ADDR&apos;, &apos;db&apos;),</span><br><span class="line">        &apos;PORT&apos;: os.environ.get(&apos;DB_PORT_5432_TCP_PORT&apos;, &apos;&apos;),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Redis</span><br><span class="line"></span><br><span class="line">REDIS_PORT = 6379  </span><br><span class="line">REDIS_DB = 0  </span><br><span class="line">REDIS_HOST = os.environ.get(&apos;REDIS_PORT_6379_TCP_ADDR&apos;, &apos;redis&apos;)</span><br><span class="line"></span><br><span class="line">RABBIT_HOSTNAME = os.environ.get(&apos;RABBIT_PORT_5672_TCP&apos;, &apos;rabbit&apos;)</span><br><span class="line"></span><br><span class="line">if RABBIT_HOSTNAME.startswith(&apos;tcp://&apos;):  </span><br><span class="line">    RABBIT_HOSTNAME = RABBIT_HOSTNAME.split(&apos;//&apos;)[1]</span><br><span class="line"></span><br><span class="line">BROKER_URL = os.environ.get(&apos;BROKER_URL&apos;,  </span><br><span class="line">                            &apos;&apos;)</span><br><span class="line">if not BROKER_URL:  </span><br><span class="line">    BROKER_URL = &apos;amqp://&#123;user&#125;:&#123;password&#125;@&#123;hostname&#125;/&#123;vhost&#125;/&apos;.format(</span><br><span class="line">        user=os.environ.get(&apos;RABBIT_ENV_USER&apos;, &apos;admin&apos;),</span><br><span class="line">        password=os.environ.get(&apos;RABBIT_ENV_RABBITMQ_PASS&apos;, &apos;mypass&apos;),</span><br><span class="line">        hostname=RABBIT_HOSTNAME,</span><br><span class="line">        vhost=os.environ.get(&apos;RABBIT_ENV_VHOST&apos;, &apos;&apos;))</span><br><span class="line"></span><br><span class="line"># We don&apos;t want to have dead connections stored on rabbitmq, so we have to negotiate using heartbeats</span><br><span class="line">BROKER_HEARTBEAT = &apos;?heartbeat=30&apos;  </span><br><span class="line">if not BROKER_URL.endswith(BROKER_HEARTBEAT):  </span><br><span class="line">    BROKER_URL += BROKER_HEARTBEAT</span><br><span class="line"></span><br><span class="line">BROKER_POOL_LIMIT = 1  </span><br><span class="line">BROKER_CONNECTION_TIMEOUT = 10</span><br><span class="line"></span><br><span class="line"># Celery configuration</span><br><span class="line"></span><br><span class="line"># configure queues, currently we have only one</span><br><span class="line">CELERY_DEFAULT_QUEUE = &apos;default&apos;  </span><br><span class="line">CELERY_QUEUES = (  </span><br><span class="line">    Queue(&apos;default&apos;, Exchange(&apos;default&apos;), routing_key=&apos;default&apos;),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># Sensible settings for celery</span><br><span class="line">CELERY_ALWAYS_EAGER = False  </span><br><span class="line">CELERY_ACKS_LATE = True  </span><br><span class="line">CELERY_TASK_PUBLISH_RETRY = True  </span><br><span class="line">CELERY_DISABLE_RATE_LIMITS = False</span><br><span class="line"></span><br><span class="line"># By default we will ignore result</span><br><span class="line"># If you want to see results and try out tasks interactively, change it to False</span><br><span class="line"># Or change this setting on tasks level</span><br><span class="line">CELERY_IGNORE_RESULT = True  </span><br><span class="line">CELERY_SEND_TASK_ERROR_EMAILS = False  </span><br><span class="line">CELERY_TASK_RESULT_EXPIRES = 600</span><br><span class="line"></span><br><span class="line"># Set redis as celery result backend</span><br><span class="line">CELERY_RESULT_BACKEND = &apos;redis://%s:%d/%d&apos; % (REDIS_HOST, REDIS_PORT, REDIS_DB)  </span><br><span class="line">CELERY_REDIS_MAX_CONNECTIONS = 1</span><br><span class="line"></span><br><span class="line"># Don&apos;t use pickle as serializer, json is much safer</span><br><span class="line">CELERY_TASK_SERIALIZER = &quot;json&quot;  </span><br><span class="line">CELERY_ACCEPT_CONTENT = [&apos;application/json&apos;]</span><br><span class="line"></span><br><span class="line">CELERYD_HIJACK_ROOT_LOGGER = False  </span><br><span class="line">CELERYD_PREFETCH_MULTIPLIER = 1  </span><br><span class="line">CELERYD_MAX_TASKS_PER_CHILD = 1000</span><br></pre></td></tr></table></figure>
<p>Those settings will configure the Django app so that it will discover the PostgreSQL database, Redis cache, and Celery.</p>
<p>Now, it’s time to connect Celery to the app. Create a file celeryconf.py and paste in this code:</p>
<p><strong>myproject/celeryconf.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">from celery import Celery  </span><br><span class="line">from django.conf import settings</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;myproject.settings&quot;)</span><br><span class="line"></span><br><span class="line">app = Celery(&apos;myproject&apos;)</span><br><span class="line"></span><br><span class="line">CELERY_TIMEZONE = &apos;UTC&apos;</span><br><span class="line"></span><br><span class="line">app.config_from_object(&apos;django.conf:settings&apos;)  </span><br><span class="line">app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</span><br></pre></td></tr></table></figure></p>
<p>That should be enough to connect Celery to our app, so the run_X scripts will work. You can read more about first steps with Django and Celery <a href="http://celery.readthedocs.org/en/latest/django/first-steps-with-django.html" target="_blank" rel="noopener">here</a>.</p>
<h1 id="Defining-tasks"><a href="#Defining-tasks" class="headerlink" title="Defining tasks"></a>Defining tasks</h1><p>Celery looks for tasks inside the tasks.py file in each Django app. Usually, tasks are created either with a decorator, or by inheriting the Celery Task Class.</p>
<p>Here’s how you can create a task using decorator:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@app.task</span><br><span class="line">def power(n):  </span><br><span class="line">    &quot;&quot;&quot;Return 2 to the n&apos;th power&quot;&quot;&quot;</span><br><span class="line">    return 2 ** n</span><br></pre></td></tr></table></figure>
<p>And here’s how you can create a task by inheriting after the Celery Task Class:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class PowerTask(app.Task):  </span><br><span class="line">    def run(self, n):</span><br><span class="line">    &quot;&quot;&quot;Return 2 to the n&apos;th power&quot;&quot;&quot;</span><br><span class="line">        return 2 ** n</span><br></pre></td></tr></table></figure>
<p>Both are fine and good for slightly different use cases.</p>
<p><strong>myproject/tasks.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">from functools import wraps</span><br><span class="line"></span><br><span class="line">from myproject.celeryconf import app  </span><br><span class="line">from .models import Job</span><br><span class="line"></span><br><span class="line"># decorator to avoid code duplication</span><br><span class="line"></span><br><span class="line">def update_job(fn):  </span><br><span class="line">    &quot;&quot;&quot;Decorator that will update Job with result of the function&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # wraps will make the name and docstring of fn available for introspection</span><br><span class="line">    @wraps(fn)</span><br><span class="line">    def wrapper(job_id, *args, **kwargs):</span><br><span class="line">        job = Job.objects.get(id=job_id)</span><br><span class="line">        job.status = &apos;started&apos;</span><br><span class="line">        job.save()</span><br><span class="line">        try:</span><br><span class="line">            # execute the function fn</span><br><span class="line">            result = fn(*args, **kwargs)</span><br><span class="line">            job.result = result</span><br><span class="line">            job.status = &apos;finished&apos;</span><br><span class="line">            job.save()</span><br><span class="line">        except:</span><br><span class="line">            job.result = None</span><br><span class="line">            job.status = &apos;failed&apos;</span><br><span class="line">            job.save()</span><br><span class="line">    return wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># two simple numerical tasks that can be computationally intensive</span><br><span class="line"></span><br><span class="line">@app.task</span><br><span class="line">@update_job</span><br><span class="line">def power(n):  </span><br><span class="line">    &quot;&quot;&quot;Return 2 to the n&apos;th power&quot;&quot;&quot;</span><br><span class="line">    return 2 ** n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.task</span><br><span class="line">@update_job</span><br><span class="line">def fib(n):  </span><br><span class="line">    &quot;&quot;&quot;Return the n&apos;th Fibonacci number.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if n &lt; 0:</span><br><span class="line">        raise ValueError(&quot;Fibonacci numbers are only defined for n &gt;= 0.&quot;)</span><br><span class="line">    return _fib(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _fib(n):  </span><br><span class="line">    if n == 0 or n == 1:</span><br><span class="line">        return n</span><br><span class="line">    else:</span><br><span class="line">        return _fib(n - 1) + _fib(n - 2)</span><br><span class="line"></span><br><span class="line"># mapping from names to tasks</span><br><span class="line"></span><br><span class="line">TASK_MAPPING = &#123;  </span><br><span class="line">    &apos;power&apos;: power,</span><br><span class="line">    &apos;fibonacci&apos;: fib</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Building-an-API-for-scheduling-tasks"><a href="#Building-an-API-for-scheduling-tasks" class="headerlink" title="Building an API for scheduling tasks"></a>Building an API for scheduling tasks</h1><p>If you have tasks in your system, how do you run them? In this section, you’ll create a user interface for job scheduling. In a backend application, the API will be your user interface. Let’s use the <a href="http://www.django-rest-framework.org/" target="_blank" rel="noopener">Django REST Framework</a> for your API.</p>
<p>To make it as simple as possible, your app will have one model and only one ViewSet (endpoint with many HTTP methods).</p>
<p>Create your model, called Job, in <strong>myproject/models.py</strong>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Job(models.Model):  </span><br><span class="line">    &quot;&quot;&quot;Class describing a computational job&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # currently, available types of job are:</span><br><span class="line">    TYPES = (</span><br><span class="line">        (&apos;fibonacci&apos;, &apos;fibonacci&apos;),</span><br><span class="line">        (&apos;power&apos;, &apos;power&apos;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # list of statuses that job can have</span><br><span class="line">    STATUSES = (</span><br><span class="line">        (&apos;pending&apos;, &apos;pending&apos;),</span><br><span class="line">        (&apos;started&apos;, &apos;started&apos;),</span><br><span class="line">        (&apos;finished&apos;, &apos;finished&apos;),</span><br><span class="line">        (&apos;failed&apos;, &apos;failed&apos;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    type = models.CharField(choices=TYPES, max_length=20)</span><br><span class="line">    status = models.CharField(choices=STATUSES, max_length=20)</span><br><span class="line"></span><br><span class="line">    created_at = models.DateTimeField(auto_now_add=True)</span><br><span class="line">    updated_at = models.DateTimeField(auto_now=True)</span><br><span class="line">    argument = models.PositiveIntegerField()</span><br><span class="line">    result = models.IntegerField(null=True)</span><br><span class="line"></span><br><span class="line">    def save(self, *args, **kwargs):</span><br><span class="line">        &quot;&quot;&quot;Save model and if job is in pending state, schedule it&quot;&quot;&quot;</span><br><span class="line">        super(Job, self).save(*args, **kwargs)</span><br><span class="line">        if self.status == &apos;pending&apos;:</span><br><span class="line">            from .tasks import TASK_MAPPING</span><br><span class="line">            task = TASK_MAPPING[self.type]</span><br><span class="line">            task.delay(job_id=self.id, n=self.argument)</span><br></pre></td></tr></table></figure>
<p>Then create a serializer, view, and URL configuration to access it.</p>
<p><strong>myproject/serializers.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from rest_framework import serializers</span><br><span class="line"></span><br><span class="line">from .models import Job</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class JobSerializer(serializers.HyperlinkedModelSerializer):  </span><br><span class="line">    class Meta:</span><br><span class="line">        model = Job</span><br></pre></td></tr></table></figure>
<p><strong>myproject/views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from rest_framework import mixins, viewsets</span><br><span class="line"></span><br><span class="line">from .models import Job  </span><br><span class="line">from .serializers import JobSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class JobViewSet(mixins.CreateModelMixin,  </span><br><span class="line">                 mixins.ListModelMixin,</span><br><span class="line">                 mixins.RetrieveModelMixin,</span><br><span class="line">                 viewsets.GenericViewSet):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    API endpoint that allows jobs to be viewed or created.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    queryset = Job.objects.all()</span><br><span class="line">    serializer_class = JobSerializer</span><br></pre></td></tr></table></figure>
<p><strong>myproject/urls.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from django.conf.urls import url, include  </span><br><span class="line">from rest_framework import routers</span><br><span class="line"></span><br><span class="line">from myproject import views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()  </span><br><span class="line"># register job endpoint in the router</span><br><span class="line">router.register(r&apos;jobs&apos;, views.JobViewSet)</span><br><span class="line"></span><br><span class="line"># Wire up our API using automatic URL routing.</span><br><span class="line"># Additionally, we include login URLs for the browsable API.</span><br><span class="line">urlpatterns = [  </span><br><span class="line">    url(r&apos;^&apos;, include(router.urls)),</span><br><span class="line">    url(r&apos;^api-auth/&apos;, include(&apos;rest_framework.urls&apos;, namespace=&apos;rest_framework&apos;))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>For completeness, there is also <strong>myproject/wsgi.py</strong>, defining WSGI config for the project:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import os  </span><br><span class="line">os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;myproject.settings&quot;)</span><br><span class="line"></span><br><span class="line">from django.core.wsgi import get_wsgi_application  </span><br><span class="line">application = get_wsgi_application()</span><br></pre></td></tr></table></figure>
<p>and <strong>manage.py</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">import os  </span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:  </span><br><span class="line">    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;myproject.settings&quot;)</span><br><span class="line"></span><br><span class="line">    from django.core.management import execute_from_command_line</span><br><span class="line"></span><br><span class="line">    execute_from_command_line(sys.argv)</span><br></pre></td></tr></table></figure>
<p>Leave <strong><strong>init</strong>.py</strong> empty.</p>
<p>That’s all. Uh… lots of code. Luckily, everything is on <a href="https://github.com/Syncano/docker-django-celery" target="_blank" rel="noopener">GitHub</a>, so you can just fork it.</p>
<h1 id="Running-the-setup"><a href="#Running-the-setup" class="headerlink" title="Running the setup"></a>Running the setup</h1><p>Since everything is run from Docker Compose, make sure you have both Docker and Docker Compose installed before you try to start the app:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /path/to/myproject/where/is/docker-compose.yml</span><br><span class="line">$ docker-compose build</span><br><span class="line">$ docker-compose up</span><br></pre></td></tr></table></figure>
<p>The last command will start five different containers, so just start using your API and have some fun with Celery in the meantime.</p>
<h1 id="Accessing-the-API"><a href="#Accessing-the-API" class="headerlink" title="Accessing the API"></a>Accessing the API</h1><p>Navigate in your browser to 127.0.0.1:8000 to browse your API and schedule some jobs.</p>
<h1 id="Scale-things-out"><a href="#Scale-things-out" class="headerlink" title="Scale things out"></a>Scale things out</h1><p>Currently, we have only one instance of each container. We can get information about our group of containers with the docker-compose ps command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose ps</span><br><span class="line">           Name                          Command               State                                        Ports                                      </span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">dockerdjangocelery_db_1       /docker-entrypoint.sh postgres   Up      0.0.0.0:5432-&gt;5432/tcp  </span><br><span class="line">dockerdjangocelery_rabbit_1   /docker-entrypoint.sh rabb ...   Up      0.0.0.0:15672-&gt;15672/tcp, 25672/tcp, 4369/tcp, 5671/tcp, 0.0.0.0:5672-&gt;5672/tcp  </span><br><span class="line">dockerdjangocelery_redis_1    /entrypoint.sh redis-server      Up      6379/tcp  </span><br><span class="line">dockerdjangocelery_web_1      ./run_web.sh                     Up      0.0.0.0:8000-&gt;8000/tcp  </span><br><span class="line">dockerdjangocelery_worker_1   ./run_celery.sh                  Up</span><br></pre></td></tr></table></figure>
<p>Scaling out a container with docker-compose is extremely easy. Just use the docker-compose scale command with the container name and amount:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose scale worker=5</span><br><span class="line">Creating and starting dockerdjangocelery_worker_2 ... done  </span><br><span class="line">Creating and starting dockerdjangocelery_worker_3 ... done  </span><br><span class="line">Creating and starting dockerdjangocelery_worker_4 ... done  </span><br><span class="line">Creating and starting dockerdjangocelery_worker_5 ... done</span><br></pre></td></tr></table></figure>
<p>Output says that docker-compose just created an additional four worker containers for us. We can double-check it with the docker-compose ps command again:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose ps</span><br><span class="line">           Name                          Command               State                                        Ports                                      </span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">dockerdjangocelery_db_1       /docker-entrypoint.sh postgres   Up      0.0.0.0:5432-&gt;5432/tcp  </span><br><span class="line">dockerdjangocelery_rabbit_1   /docker-entrypoint.sh rabb ...   Up      0.0.0.0:15672-&gt;15672/tcp, 25672/tcp, 4369/tcp, 5671/tcp, 0.0.0.0:5672-&gt;5672/tcp  </span><br><span class="line">dockerdjangocelery_redis_1    /entrypoint.sh redis-server      Up      6379/tcp  </span><br><span class="line">dockerdjangocelery_web_1      ./run_web.sh                     Up      0.0.0.0:8000-&gt;8000/tcp  </span><br><span class="line">dockerdjangocelery_worker_1   ./run_celery.sh                  Up  </span><br><span class="line">dockerdjangocelery_worker_2   ./run_celery.sh                  Up  </span><br><span class="line">dockerdjangocelery_worker_3   ./run_celery.sh                  Up  </span><br><span class="line">dockerdjangocelery_worker_4   ./run_celery.sh                  Up  </span><br><span class="line">dockerdjangocelery_worker_5   ./run_celery.sh                  Up</span><br></pre></td></tr></table></figure>
<p>You’ll see there five powerful Celery workers. Nice!</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Congrats! You just married Django with Celery to build a distributed asynchronous computation system. I think you’ll agree it was pretty easy to build an API, and even easier to scale workers for it! However, life isn’t always so nice to us, and sometimes we have to troubleshoot.</p>
<h3 id="Contribution"><a href="#Contribution" class="headerlink" title="Contribution"></a>Contribution</h3><p>Original article written by Justyna Ilczuk, updated by Michał Kobus.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2016/11/22/configuring-and-running-django--celery-in-docker-containers/" data-id="cm50h3ra3004uyfhtlufrttbv" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2016/11/22/configuring-and-running-django--celery-in-docker-containers/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-5-favorite-open-source-django-packages" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/21/5-favorite-open-source-django-packages/" class="article-date">
  <time datetime="2016-10-20T16:00:00.000Z" itemprop="datePublished">2016-10-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/django/">django</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/21/5-favorite-open-source-django-packages/">5 favorite open source Django packages</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>this blog translate from <a href="ttps://opensource.com/business/15/12/5-favorite-open-source-django-packages" target="_blank" rel="noopener">https://opensource.com/business/15/12/5-favorite-open-source-django-packages</a></p>
<p>Django is built around the concept of reusable apps: self-contained packages that provide re-usable features. You can build your site by composing these reusable apps, together with your own site-specific code. There’s a rich and varied ecosystem of reusable apps available for your use—PyPI lists more than 8,000 Django apps—but how do you know which ones are best?</p>
<p>To help focus your app search, we’ve put together this list of our five favorites. They are:</p>
<ul>
<li><a href="https://github.com/audreyr/cookiecutter" target="_blank" rel="noopener">Cookiecutter</a>: the best way to start a new Django site.</li>
<li><a href="https://github.com/audreyr/cookiecutter" target="_blank" rel="noopener">Whitenoise</a>: the best static asset server.</li>
<li><a href="http://www.django-rest-framework.org/" target="_blank" rel="noopener">Django Rest Framework</a>: the best way to write REST APIs with Django.</li>
<li><a href="https://wagtail.io/" target="_blank" rel="noopener">Wagtail</a>: the best Django-based content-management system.</li>
<li><a href="http://www.intenct.nl/projects/django-allauth/" target="_blank" rel="noopener">django-allauth</a>: the best way to provide “social login” (e.g., Twitter, Facebook, GitHub, etc).</li>
</ul>
<p>We also recommend you check out <a href="https://www.djangopackages.com/" target="_blank" rel="noopener">Django Packages</a>, a directory of reusable Django apps. Django Packages organizes Django apps into “grids” that allow you to compare similar packages and chose between them. You can see which features are offered by each package, as well as usage statistics. (For example: here’s <a href="https://www.djangopackages.com/grids/g/rest/" target="_blank" rel="noopener">the grid for REST tools</a>, which might help you understand why we recommend Django REST Framework.)</p>
<h2 id="Why-you-should-trust-us"><a href="#Why-you-should-trust-us" class="headerlink" title="Why you should trust us?"></a>Why you should trust us?</h2><p>We’ve been using Django for longer than almost anyone. Two of us (Frank and Jacob) worked at the Lawrence Journal-World (birthplace of Django) before Django was released (and in fact helped make the open source release happen). We’ve all spent the past eight years running a consultancy that advises companies on how best to use Django.</p>
<p>So, we’ve seen the entire history of the Django project and community, and we’ve seen popular packages come and go. Between the three of us, we’ve probably tried at least half of these 8,000 apps personally, or we know someone who has. We have a strong understanding of what makes an app solid and reliable, and we have a good understanding of what gives these things staying power.</p>
<h2 id="Best-way-to-start-a-new-Django-site-Cookiecutter"><a href="#Best-way-to-start-a-new-Django-site-Cookiecutter" class="headerlink" title="Best way to start a new Django site: Cookiecutter"></a>Best way to start a new Django site: Cookiecutter</h2><p>Starting off a new project or app is always a bit of a pain. You can use Django’s built in <code>startproject</code> but if you’re like us, you’re particular in how you do things. Cookiecutter solves this by giving you a quick and easy way to define project or app templates that can be easily reused. A quick example, just <code>pip install cookiecutter</code> and then run this from the command line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cookiecutter https://github.com/marcofucci/cookiecutter-simple-django</span><br></pre></td></tr></table></figure>
<p>You’ll immediately start getting prompted for quick answers, such as the name of your project, repo, author name, email, and a few other bits of configuration. These are used to help fill out the project details. We picked the ever so original ‘foo’ to be our repo name. So cookiecutter created a simple Django project in the subdirectory ‘foo’.</p>
<p>If you poke around in the ‘foo’ project a bit, you’ll see the other bits of configuration you were prompted for have been templated into the files themselves along with sub-directories as necessary. This “template” is all defined at the GitHub repo URL we used as the only argument when we called <code>cookiecutter</code>. This example used a remote GitHub repo as the template; however, note that you can use local file system directories as well, which is perfect for non-reusable scenarios.</p>
<p>We mention cookiecutter as a great Django package, but honestly it’s useful for plain Python or even non-Python-related purposes. Being able to lay things out exactly as you like in an easily repeatable way makes cookiecutter a great tool for keeping your workflow DRY.</p>
<h2 id="Best-static-asset-server-Whitenoise"><a href="#Best-static-asset-server-Whitenoise" class="headerlink" title="Best static asset server: Whitenoise"></a>Best static asset server: <a href="http://whitenoise.evans.io/en/latest/base.html" target="_blank" rel="noopener">Whitenoise</a></h2><p>For many years, serving your site’s static assets—images, JavaScript, CSS—was a pain. The built-in django.views.static.serve view is, as the documentation states, “not hardened for production use and should be used only as a development aid.” But serving media from a “real” web server, such as NGINX or out of a CDN, can be difficult to set up.</p>
<p>Whitenoise cleanly solves this problem. It’s as easy to set up as the development-only static server, and is hardened and optimized for production. Setup is simple:</p>
<ol>
<li>Make sure you’re using Django’s contrib.staticfiles app, and that you’ve correctly set <code>STATIC_ROOT</code> in your settings file.</li>
<li>Enable Whitenoise in your <code>wsgi.py</code> file:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.core.wsgi import get_wsgi_application</span><br><span class="line">from whitenoise.django import DjangoWhiteNoise</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">application = get_wsgi_application()</span><br><span class="line">application = DjangoWhiteNoise(application)</span><br></pre></td></tr></table></figure>
<p>That’s really all it takes! For large applications, you’ll likely want to use a dedicated media server and/or a CDN, but for most small- or medium-sized Django sites, Whitenoise is more than powerful enough.</p>
<p>For more information on Whitenoise, <a href="http://whitenoise.evans.io/en/latest/index.html" target="_blank" rel="noopener">check out the documentation</a>.</p>
<h2 id="Best-Tool-for-REST-APIs-Django-REST-Framework"><a href="#Best-Tool-for-REST-APIs-Django-REST-Framework" class="headerlink" title="Best Tool for REST APIs: Django REST Framework"></a>Best Tool for REST APIs: <a href="http://www.django-rest-framework.org/" target="_blank" rel="noopener">Django REST Framework</a></h2><p>REST APIs are quickly becoming a standard feature of modern web applications. An API is really simply talking in JSON rather than HTML, and of course you can do this with just Django. You can craft your own views that set the proper content types and return data in JSON rather than templated HTML responses. This is exactly what many people did before API frameworks such as <a href="http://www.django-rest-framework.org/" target="_blank" rel="noopener">Django Rest Framework</a> (a.k.a., DRF) were released.</p>
<p>Building a REST API with DRF is similar to working with Django’s Class Based Views if you’re familiar with them, except these are specifically designed and targeted around an API use case. Quite a bit of code is involved in your average API setup, so instead of a code sample to get you excited, we’ll highlight some of DRF’s features that make your life easier:</p>
<ul>
<li>Automatic browseable API which makes development and manual testing a breeze. Click around in the DRF <a href="http://restframework.herokuapp.com/" target="_blank" rel="noopener">demo example</a>. You can view API responses and support POST/PUT/DELETE type operations without having to do anything yourself.</li>
<li>Easy integration of authentication styles, such as OAuth, Basic Auth, or API Tokens.</li>
<li>Simple permission system for fine-grained control of which users can use which API endpoints and/or actions.</li>
<li>Built in rate limiting.</li>
<li>Nearly automatic API documentation when combined with <a href="http://django-rest-swagger.readthedocs.org/en/latest/index.html" target="_blank" rel="noopener">django-rest-swagger</a>.</li>
<li>Extensive ecosystem of third-party libraries.</li>
</ul>
<p>Although you could certainly build an API without DRF, we can’t fathom a reason why you would start off down that path. Even if you don’t use all of DRF’s features, building up your own API views from their solid base view classes is a huge win in terms of safety, consistency of your API, and development velocity. If you aren’t using DRF already, you should set aside some time to check it out.</p>
<p>Best Django-based CMS: <a href="https://wagtail.io/" target="_blank" rel="noopener">Wagtail</a></p>
<p>Wagtail is the current darling of the Django CMS world and with good reason. Like most CMS systems, it gives you flexibility to define different types of pages and their content via simple Django models. This takes you from zero to a basically working system in hours, not days. To give you a quick example, to define a Staff page type for people at your company can be as simple as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from wagtail.wagtailcore.models import Page</span><br><span class="line">from wagtail.wagtailcore.fields import RichTextField</span><br><span class="line">from wagtail.wagtailadmin.edit_handlers import FieldPanel, MultiFieldPanel</span><br><span class="line">from wagtail.wagtailimages.edit_handlers import ImageChooserPanel </span><br><span class="line"></span><br><span class="line">class StaffPage(Page):</span><br><span class="line">	name = models.CharField(max_length=100)</span><br><span class="line">	hire_date = models.DateField()</span><br><span class="line">	bio = models.RichTextField()</span><br><span class="line">	email = models.EmailField()</span><br><span class="line">	headshot = models.ForeignKey(&apos;wagtailimages.Image&apos;, null=True, blank=True) </span><br><span class="line">	content_panels = Page.content_panels + [</span><br><span class="line"> 		FieldPanel(&apos;name&apos;),</span><br><span class="line">		FieldPanel(&apos;hire_date&apos;),</span><br><span class="line">		FieldPanel(&apos;email&apos;),</span><br><span class="line">		FieldPanel(&apos;bio&apos;,classname=&quot;full&quot;),</span><br><span class="line">		ImageChoosePanel(&apos;headshot&apos;),</span><br><span class="line">		]</span><br></pre></td></tr></table></figure>
<p>The real appeal of Wagtail, however, is in its easy-to-use modern admin interface and flexibility. You can control which types of pages are allowed in different areas of the site, add additional complex logic to your pages, and get standard moderation/approval workflows right out of the box. With most CMS systems, at some point you run into a wall you can work around. With Wagtail, we have yet to find a wall we couldn’t easy find a door through to make it do exactly what we want in an easy and maintainable way. If you’re interested, we wrote up a (deeper dive into Wagtail)[<a href="https://opensource.com/business/15/5/wagtail-cms]" target="_blank" rel="noopener">https://opensource.com/business/15/5/wagtail-cms]</a>.</p>
<h2 id="Best-Social-Login-Tool-django-allauth"><a href="#Best-Social-Login-Tool-django-allauth" class="headerlink" title="Best Social Login Tool: django-allauth"></a>Best Social Login Tool: <a href="http://www.intenct.nl/projects/django-allauth/" target="_blank" rel="noopener">django-allauth</a></h2><p>django-allauth is a reusable Django application that solves your registration and authentication needs. Whether you need a local or social registration system, django-allauth has you covered.</p>
<p>The project supports multiple authentication schemes, such as user name or email address. Once a user has signed up, multiple strategies are supported for account verification ranging from none to email verification. Multiple social and email accounts are also supported. Pluggable signup forms are also supports which allows asking additional questions during registration.</p>
<p>django-allauth supports more than 20 authentication providers, including Facebook, GitHub, Google, and Twitter. If you have an account on a social website that’s not supported, then it’s most supported through a third-party add-on. The project supports writing custom backends, which allows custom authentication systems to work, too. This is nice for anyone with custom authentication needs.</p>
<p>django-allauth is easy to setup and has <a href="http://django-allauth.readthedocs.org/en/latest/" target="_blank" rel="noopener">extensive documentation</a>. The project is also well tested so you know that everything actually works.</p>
<p>Do you have a favorite Django package? Let us know about it in the comments.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2016/10/21/5-favorite-open-source-django-packages/" data-id="cm50h3r9x004qyfhtisy074q5" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2016/10/21/5-favorite-open-source-django-packages/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-find-some-characters-in-all-files-in-linux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/03/how-to-find-some-characters-in-all-files-in-linux/" class="article-date">
  <time datetime="2016-09-02T16:00:00.000Z" itemprop="datePublished">2016-09-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/03/how-to-find-some-characters-in-all-files-in-linux/">How to find some characters in all files in linux</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you want find the characters “hello,world!” in the current folder. you can do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rn &quot;hello,world!&quot; *</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* current folder,or some folder name</span><br><span class="line">-r recursion to find</span><br><span class="line">-n display the line number</span><br><span class="line">-R search all folder include sub folders</span><br><span class="line">-i ignore case</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2016/09/03/how-to-find-some-characters-in-all-files-in-linux/" data-id="cm50h3r9u004kyfhtprfaxz73" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2016/09/03/how-to-find-some-characters-in-all-files-in-linux/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-12-useful-pandas-techniques-in-python-for-data-manipulation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/12/12-useful-pandas-techniques-in-python-for-data-manipulation/" class="article-date">
  <time datetime="2016-08-11T16:00:00.000Z" itemprop="datePublished">2016-08-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/12/12-useful-pandas-techniques-in-python-for-data-manipulation/">12 Useful Pandas Techniques in Python for Data Manipulation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>12 Useful Pandas Techniques in Python for Data Manipulation</em></p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Python is fast becoming the preferred language for data scientists – and for good reasons. It provides the larger ecosystem of a programming language and the depth of good scientific computation libraries. If you are starting to learn Python, have a look at learning path on Python.</p>
<p>Among its scientific computation libraries, I found Pandas to be the most useful for data science operations. Pandas, along with Scikit-learn provides almost the entire stack needed by a data scientist. This article focuses on providing 12 ways for data manipulation in Python. I’ve also shared some tips &amp; tricks which will allow you to work faster.</p>
<p>I would recommend that you look at the codes for data exploration before going ahead. To help you understand better, I’ve taken a data set to perform these operations and manipulations.</p>
<p>Data Set: I’ve used the data set of Loan Prediction problem. Download the data set and get started.</p>
<h1 id="Let’s-get-started"><a href="#Let’s-get-started" class="headerlink" title="Let’s get started"></a>Let’s get started</h1><p>I’ll start by importing modules and loading the data set into Python environment:</p>
<pre><code>import pandas as pd
import numpy as np
data = pd.read_csv(&quot;train.csv&quot;, index_col=&quot;Loan_ID&quot;)
</code></pre><h1 id="1-–-Boolean-Indexing"><a href="#1-–-Boolean-Indexing" class="headerlink" title="1 – Boolean Indexing"></a>1 – Boolean Indexing</h1><p>What do you do, if you want to filter values of a column based on conditions from another set of columns? For instance, we want a list of all females who are not graduate and got a loan. Boolean indexing can help here. You can use the following code:</p>
<pre><code>data.loc[(data[&quot;Gender&quot;]==&quot;Female&quot;) &amp; (data[&quot;Education&quot;]==&quot;Not Graduate&quot;) &amp; (data[&quot;Loan_Status&quot;]==&quot;Y&quot;), [&quot;Gender&quot;,&quot;Education&quot;,&quot;Loan_Status&quot;]]
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/1.-boolean-indexing-217x300.png" alt></p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/indexing.html" target="_blank" rel="noopener">Pandas Selecting and Indexing</a></p>
<h1 id="2-–-Apply-Function"><a href="#2-–-Apply-Function" class="headerlink" title="2 – Apply Function"></a>2 – Apply Function</h1><p>It is one of the commonly used functions for playing with data and creating new variables. Apply returns some value after passing each row/column of a data frame with some function. The function can be both default or user-defined. For instance, here it can be used to find the #missing values in each row and column.</p>
<p>Create a new function:</p>
<pre><code>def num_missing(x):
    return sum(x.isnull())
</code></pre><p>Applying per column:</p>
<pre><code>print &quot;Missing values per column:&quot;
print data.apply(num_missing, axis=0) #axis=0 defines that function is to be applied on each column
</code></pre><p>Applying per row:</p>
<pre><code>print &quot;\nMissing values per row:&quot;
print data.apply(num_missing, axis=1).head() #axis=1 defines that function is to be applied on each row
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/3-apply-161x300.png" alt></p>
<p>Thus we get the desired result.</p>
<p>Note: head() function is used in second output because it contains many rows.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.apply.html#pandas.DataFrame.apply" target="_blank" rel="noopener">Pandas Reference (apply)</a></p>
<h1 id="3-–-Imputing-missing-files"><a href="#3-–-Imputing-missing-files" class="headerlink" title="3 – Imputing missing files"></a>3 – Imputing missing files</h1><p>‘fillna()’ does it in one go. It is used for updating missing values with the overall mean/mode/median of the column. Let’s impute the ‘Gender’, ‘Married’ and ‘Self_Employed’ columns with their respective modes.</p>
<p>First we import a function to determine the mode</p>
<pre><code>from scipy.stats import mode
mode(data[&apos;Gender&apos;])
</code></pre><p>Output: <em>ModeResult(mode=array([‘Male’], dtype=object), count=array([489]))</em></p>
<p>This returns both mode and count. Remember that mode can be an array as there can be multiple values with high frequency. We will take the first one by default always using:</p>
<pre><code>mode(data[&apos;Gender&apos;]).mode[0]
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/4.2-mode2.png" alt></p>
<p>Now we can fill the missing values and check using technique #2.</p>
<p>Impute the values:</p>
<pre><code>data[&apos;Gender&apos;].fillna(mode(data[&apos;Gender&apos;]).mode[0], inplace=True)
data[&apos;Married&apos;].fillna(mode(data[&apos;Married&apos;]).mode[0], inplace=True)
data[&apos;Self_Employed&apos;].fillna(mode(data[&apos;Self_Employed&apos;]).mode[0], inplace=True)
</code></pre><p>Now check the #missing values again to confirm:</p>
<pre><code>print data.apply(num_missing, axis=0)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/4.3-after-impute.png" alt></p>
<p>Hence, it is confirmed that missing values are imputed. Please note that this is the most primitive form of imputation. Other sophisticated techniques include modeling the missing values, using grouped averages (mean/mode/median). I’ll cover that part in my next articles.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.fillna.html#pandas.DataFrame.fillna" target="_blank" rel="noopener">Pandas Reference (fillna)</a></p>
<h1 id="4-–-Pivot-Table"><a href="#4-–-Pivot-Table" class="headerlink" title="4 – Pivot Table"></a>4 – Pivot Table</h1><p>Pandas can be used to create MS Excel style pivot tables. For instance, in this case, a key column is “LoanAmount” which has missing values. We can impute it using mean amount of each ‘Gender’, ‘Married’ and ‘Self_Employed’ group. The mean ‘LoanAmount’ of each group can be determined as:</p>
<p>Determine pivot table</p>
<pre><code>impute_grps = data.pivot_table(values=[&quot;LoanAmount&quot;], index=[&quot;Gender&quot;,&quot;Married&quot;,&quot;Self_Employed&quot;], aggfunc=np.mean)
print impute_grps
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/5.-pivot-table-262x141.png" alt></p>
<p>More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.pivot_table.html#pandas.DataFrame.pivot_table" target="_blank" rel="noopener">Pandas Reference (Pivot Table)</a></p>
<h1 id="5-–-Multi-Indexing"><a href="#5-–-Multi-Indexing" class="headerlink" title="5 – Multi-Indexing"></a>5 – Multi-Indexing</h1><p>If you notice the output of step #3, it has a strange property. Each index is made up of a combination of 3 values. This is called Multi-Indexing. It helps in performing operations really fast.</p>
<p>Continuing the example from #3, we have the values for each group but they have not been imputed.<br>This can be done using the various techniques learned till now.</p>
<p>iterate only through rows with missing LoanAmount</p>
<pre>
    for i,row in data.loc[data['LoanAmount'].isnull(),:].iterrows():
        ind = tuple([row['Gender'],row['Married'],row['Self_Employed']])
        data.loc[i,'LoanAmount'] = impute_grps.loc[ind].values[0]
</pre>


<p>Now check the #missing values again to confirm:</p>
<pre><code>print data.apply(num_missing, axis=0)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/6.-multi-indexing.png" alt></p>
<p>Note:</p>
<p>1.Multi-index requires tuple for defining groups of indices in loc statement. This a tuple used in function.<br>2.The .values[0] suffix is required because, by default a series element is returned which has an index not matching with that of the dataframe. In this case, a direct assignment gives an error.</p>
<h1 id="6-Crosstab"><a href="#6-Crosstab" class="headerlink" title="6. Crosstab"></a>6. Crosstab</h1><p>This function is used to get an initial “feel” (view) of the data. Here, we can validate some basic hypothesis. For instance, in this case, “Credit_History” is expected to affect the loan status significantly. This can be tested using cross-tabulation as shown below:</p>
<pre><code>pd.crosstab(data[&quot;Credit_History&quot;],data[&quot;Loan_Status&quot;],margins=True)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/7.1-abs-crosstab.png" alt></p>
<p>These are absolute numbers. But, percentages can be more intuitive in making some quick insights. We can do this using the apply function:</p>
<pre><code>def percConvert(ser):
    return ser/float(ser[-1])
    pd.crosstab(data[&quot;Credit_History&quot;],data[&quot;Loan_Status&quot;],margins=True).apply(percConvert, axis=1)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/7.2-perc-crosstab.png" alt></p>
<p>Now, it is evident that people with a credit history have much higher chances of getting a loan as 80% people with credit history got a loan as compared to only 9% without credit history.</p>
<p>But that’s not it. It tells an interesting story. Since I know that having a credit history is super important, what if I predict loan status to be Y for ones with credit history and N otherwise. Surprisingly, we’ll be right 82+378=460 times out of 614 which is a whopping 75%!</p>
<p>I won’t blame you if you’re wondering why the hell do we need statistical models. But trust me, increasing the accuracy by even 0.001% beyond this mark is a challenging task. Would you take this challenge?</p>
<p>Note: 75% is on train set. The test set will be slightly different but close. Also, I hope this gives some intuition into why even a 0.05% increase in accuracy can result in jump of 500 ranks on the Kaggle leaderboard.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/version/0.17.0/generated/pandas.crosstab.html" target="_blank" rel="noopener">Pandas Reference (crosstab)</a></p>
<h1 id="7-–-Merge-DataFrames"><a href="#7-–-Merge-DataFrames" class="headerlink" title="7 – Merge DataFrames"></a>7 – Merge DataFrames</h1><p>Merging dataframes become essential when we have information coming from different sources to be collated. Consider a hypothetical case where the average property rates (INR per sq meters) is available for different property types. Let’s define a dataframe as:</p>
<pre><code>prop_rates = pd.DataFrame([1000, 5000, 12000], index=[&apos;Rural&apos;,&apos;Semiurban&apos;,&apos;Urban&apos;],columns=[&apos;rates&apos;])
prop_rates
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/8.1-rates.png" alt></p>
<p>Now we can merge this information with the original dataframe as:</p>
<pre><code>data_merged = data.merge(right=prop_rates, how=&apos;inner&apos;,left_on=&apos;Property_Area&apos;,right_index=True, sort=False)
data_merged.pivot_table(values=&apos;Credit_History&apos;,index=[&apos;Property_Area&apos;,&apos;rates&apos;], aggfunc=len)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/8.2-pivot.png" alt></p>
<p>The pivot table validates successful merge operation. Note that the ‘values’ argument is irrelevant here because we are simply counting the values.</p>
<p>ReadMore: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.merge.html#pandas.DataFrame.merge" target="_blank" rel="noopener">Pandas Reference (merge)</a></p>
<h1 id="8-–-Sorting-DataFrames"><a href="#8-–-Sorting-DataFrames" class="headerlink" title="8 – Sorting DataFrames"></a>8 – Sorting DataFrames</h1><p>Pandas allow easy sorting based on multiple columns. This can be done as:</p>
<pre><code>data_sorted = data.sort_values([&apos;ApplicantIncome&apos;,&apos;CoapplicantIncome&apos;], ascending=False)
data_sorted[[&apos;ApplicantIncome&apos;,&apos;CoapplicantIncome&apos;]].head(10)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/9.-sort-300x295.png" alt></p>
<p>Note: Pandas “sort” function is now deprecated. We should use “sort_values” instead.</p>
<p>More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.sort_values.html#pandas.DataFrame.sort_values" target="_blank" rel="noopener">Pandas Reference (sort_values)</a></p>
<h1 id="9-–-Plotting-Boxplot-amp-Histogram"><a href="#9-–-Plotting-Boxplot-amp-Histogram" class="headerlink" title="9 – Plotting (Boxplot &amp; Histogram)"></a>9 – Plotting (Boxplot &amp; Histogram)</h1><p>Many of you might be unaware that boxplots and histograms can be directly plotted in Pandas and calling matplotlib separately is not necessary. It’s just a 1-line command. For instance, if we want to compare the distribution of ApplicantIncome by Loan_Status:</p>
<pre><code>import matplotlib.pyplot as plt
%matplotlib inline
data.boxplot(column=&quot;ApplicantIncome&quot;,by=&quot;Loan_Status&quot;)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/10.1-boxplot-300x215.png" alt></p>
<pre><code>data.hist(column=&quot;ApplicantIncome&quot;,by=&quot;Loan_Status&quot;,bins=30)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/10.2-hist-300x217.png" alt></p>
<p>This shows that income is not a big deciding factor on its own as there is no appreciable difference between the people who received and were denied the loan.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.hist.html#pandas.DataFrame.hist" target="_blank" rel="noopener">Pandas Reference (hist)</a>|<a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.boxplot.html#pandas.DataFrame.boxplot" target="_blank" rel="noopener"> Pandas Reference (boxplot)</a></p>
<h1 id="10-–-Cut-function-for-binning"><a href="#10-–-Cut-function-for-binning" class="headerlink" title="10 – Cut function for binning"></a>10 – Cut function for binning</h1><p>Sometimes numerical values make more sense if clustered together. For example, if we’re trying to model traffic (#cars on road) with time of the day (minutes). The exact minute of an hour might not be that relevant for predicting traffic as compared to actual period of the day like “Morning”, “Afternoon”, “Evening”, “Night”, “Late Night”. Modeling traffic this way will be more intuitive and will avoid overfitting.</p>
<p>Here we define a simple function which can be re-used for binning any variable fairly easily.</p>
<p>Binning:</p>
<pre><code>def binning(col, cut_points, labels=None):
    #Define min and max values:
    minval = col.min()
    maxval = col.max()

#create list by adding min and max to cut_points
break_points = [minval] + cut_points + [maxval]

#if no labels provided, use default labels 0 ... (n-1)
if not labels:
    labels = range(len(cut_points)+1)

#Binning using cut function of pandas
colBin = pd.cut(col,bins=break_points,labels=labels,include_lowest=True)
return colBin

#Binning age:
cut_points = [90,140,190]
labels = [&quot;low&quot;,&quot;medium&quot;,&quot;high&quot;,&quot;very high&quot;]
data[&quot;LoanAmount_Bin&quot;] = binning(data[&quot;LoanAmount&quot;], cut_points, labels)
print pd.value_counts(data[&quot;LoanAmount_Bin&quot;], sort=False)
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/01/eg12-257x144.png" alt></p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/version/0.17.1/generated/pandas.cut.html" target="_blank" rel="noopener">Pandas Reference (cut)</a></p>
<h1 id="11-–-Coding-nominal-data"><a href="#11-–-Coding-nominal-data" class="headerlink" title="11 – Coding nominal data"></a>11 – Coding nominal data</h1><p>Often, we find a case where we’ve to modify the categories of a nominal variable. This can be due to various reasons:</p>
<p>1.Some algorithms (like Logistic Regression) require all inputs to be numeric. So nominal variables are mostly coded as 0, 1….(n-1)<br>2.Sometimes a category might be represented in 2 ways. For e.g. temperature might be recorded as “High”, “Medium”, “Low”, “H”, “low”. Here, both “High” and “H” refer to same category. Similarly, in “Low” and “low” there is only a difference of case. But, python would read them as different levels.<br>3.Some categories might have very low frequencies and its generally a good idea to combine them.</p>
<p>Here I’ve defined a generic function which takes in input as a dictionary and codes the values using ‘replace’ function in Pandas.</p>
<pre><code>#Define a generic function using Pandas replace function
def coding(col, codeDict):
    colCoded = pd.Series(col, copy=True)
    for key, value in codeDict.items():
        colCoded.replace(key, value, inplace=True)
    return colCoded

#Coding LoanStatus as Y=1, N=0:
print &apos;Before Coding:&apos;
print pd.value_counts(data[&quot;Loan_Status&quot;])
data[&quot;Loan_Status_Coded&quot;] = coding(data[&quot;Loan_Status&quot;], {&apos;N&apos;:0,&apos;Y&apos;:1})
print &apos;\nAfter Coding:&apos;
print pd.value_counts(data[&quot;Loan_Status_Coded&quot;])
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/12.-code.png" alt></p>
<p>Similar counts before and after proves the coding.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.replace.html#pandas.DataFrame.replace" target="_blank" rel="noopener">Pandas Reference (replace)</a></p>
<h1 id="12-–-Iterating-over-rows-of-a-dataframe"><a href="#12-–-Iterating-over-rows-of-a-dataframe" class="headerlink" title="12 – Iterating over rows of a dataframe"></a>12 – Iterating over rows of a dataframe</h1><p>This is not a frequently used operation. Still, you don’t want to get stuck. Right? At times you may need to iterate through all rows using a for loop. For instance, one common problem we face is the incorrect treatment of variables in Python. This generally happens when:</p>
<p>1.Nominal variables with numeric categories are treated as numerical.<br>2.Numeric variables with characters entered in one of the rows (due to a data error) are considered categorical.</p>
<p>So it’s generally a good idea to manually define the column types. If we check the data types of all columns:</p>
<pre><code>#Check current type:
data.dtypes
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2015/12/2.1-initial-type.png" alt></p>
<p>Here we see that Credit_History is a nominal variable but appearing as float. A good way to tackle such issues is to create a csv file with column names and types. This way, we can make a generic function to read the file and assign column data types. For instance, here I have created a csv file datatypes.csv.</p>
<pre><code>#Load the file:
colTypes = pd.read_csv(&apos;datatypes.csv&apos;)
print colTypes
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/01/2.2-file-content-300x227.png" alt></p>
<p>After loading this file, we can iterate through each row and assign the datatype using column ‘type’ to the variable name defined in the ‘feature’ column.</p>
<pre><code>#Iterate through each row and assign variable type.
#Note: astype is used to assign types

for i, row in colTypes.iterrows():  #i: dataframe index; row: each row in series format
    if row[&apos;type&apos;]==&quot;categorical&quot;:
        data[row[&apos;feature&apos;]]=data[row[&apos;feature&apos;]].astype(np.object)
    elif row[&apos;type&apos;]==&quot;continuous&quot;:
        data[row[&apos;feature&apos;]]=data[row[&apos;feature&apos;]].astype(np.float)
print data.dtypes
</code></pre><p><img src="https://www.analyticsvidhya.com/wp-content/uploads/2016/01/2.3-after-changing-300x276.png" alt></p>
<p>Now the credit history column is modified to ‘object’ type which is used for representing nominal variables in Pandas.</p>
<p>Read More: <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.iterrows.html#pandas.DataFrame.iterrows" target="_blank" rel="noopener">Pandas Reference (iterrows)</a></p>
<h1 id="End-Notes"><a href="#End-Notes" class="headerlink" title="End Notes"></a>End Notes</h1><p>In this article, we covered various functions of Pandas which can make our life easy while performing data exploration and feature engineering. Also, we defined some generic functions which can be reused for achieving similar objective on different datasets.</p>
<p>Also See: If you have any doubts pertaining to Pandas or Python in general, feel free to discuss with us.</p>
<p>Did you find the article useful? Do you use some better (easier/faster) techniques for performing the tasks discussed above? Do you think there are better alternatives to Pandas in Python? We’ll be glad if you share your thoughts as comments below.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tonytan748.github.io/2016/08/12/12-useful-pandas-techniques-in-python-for-data-manipulation/" data-id="cm50h3r9w004oyfhtwqug17w3" class="article-share-link">Share</a>
      
        <a href="https://tonytan748.github.io/2016/08/12/12-useful-pandas-techniques-in-python-for-data-manipulation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Github/">Github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Karrigell/">Karrigell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/VIM/">VIM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/conda/">conda</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/django/">django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ffmpeg/">ffmpeg</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/freeswitch/">freeswitch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jekyll/">jekyll</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kivy/">kivy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/mac/">mac</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/normal/">normal</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sqlalchemy/">sqlalchemy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system/">system</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tornado/">tornado</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ubuntu/">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/conda/">conda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django-celery/">django-celery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg/">ffmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/freeswitch/">freeswitch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/">other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlalchemy/">sqlalchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system/">system</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tornado/">tornado</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/conda/" style="font-size: 10px;">conda</a> <a href="/tags/django/" style="font-size: 18px;">django</a> <a href="/tags/django-celery/" style="font-size: 10px;">django-celery</a> <a href="/tags/ffmpeg/" style="font-size: 10px;">ffmpeg</a> <a href="/tags/flask/" style="font-size: 10px;">flask</a> <a href="/tags/freeswitch/" style="font-size: 10px;">freeswitch</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 14px;">go</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/other/" style="font-size: 12px;">other</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/system/" style="font-size: 12px;">system</a> <a href="/tags/tornado/" style="font-size: 10px;">tornado</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/12/23/Python-Typing类型提示/">Python Typing类型提示</a>
          </li>
        
          <li>
            <a href="/2024/12/23/Python-Tempfile临时文件系统对象/">Python Tempfile临时文件系统对象</a>
          </li>
        
          <li>
            <a href="/2024/12/23/Python-Pathlib处理文件路径库的使用/">Python Pathlib处理文件路径库的使用</a>
          </li>
        
          <li>
            <a href="/2024/08/31/在ubuntu上的18个非常实用的命令行工具软件/">在ubuntu上的18个非常实用的命令行工具软件</a>
          </li>
        
          <li>
            <a href="/2024/08/20/什么是动态规划？在Python中如何利用动态规划解决实际问题？/">什么是动态规划？在Python中如何利用动态规划解决实际问题？</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Tony Tan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'TonyTan';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>